layui.define(["layer","laytpl","upload"],function(aX){var a6="3.6.0 Pro",a2=layui.$,aM=layui.layer,aS=layui.laytpl,aU=layui.device(),aN="layui-show",aR="layim-this",a3=20,aO={},a4=function(){this.v=a6,a2("body").on("click","*[layim-event]",function(d){var b=a2(this),c=b.attr("layim-event");aa[c]?aa[c].call(this,b,d):""})};a4.prototype.config=function(c){var b=[];if(layui.each(Array(5),function(a){b.push(layui.cache.dir+"css/modules/layim/skin/"+(a+1)+".jpg")}),c=c||{},c.skin=c.skin||[],layui.each(c.skin,function(a,d){b.unshift(d)}),c.skin=b,c=a2.extend({isfriend:!0,isgroup:!0,voice:"default.mp3"},c),window.JSON&&window.JSON.parse){return aw(c),this}},a4.prototype.on=function(c,b){return"function"==typeof b&&(aO[c]?aO[c].push(b):aO[c]=[b]),this},a4.prototype.cache=function(){return aW},a4.prototype.chat=function(a){if(window.JSON&&window.JSON.parse){return aG(a),this}},a4.prototype.setChatMin=function(){return ao(),this},a4.prototype.setChatStatus=function(c){var b=a7();if(b){var d=b.elem.find(".layim-chat-status");return d.html(c),this}},a4.prototype.getMessage=function(a){return ar(a),this},a4.prototype.notice=function(a){return at(a),this},a4.prototype.add=function(a){return ap(a),this},a4.prototype.setFriendGroup=function(a){return ap(a,"setGroup"),this},a4.prototype.msgbox=function(a){return af(a),this},a4.prototype.addList=function(a){return ag(a),this},a4.prototype.removeList=function(a){return ae(a),this},a4.prototype.setFriendStatus=function(d,b){var c=a2(".layim-friend"+d);c["online"===b?"removeClass":"addClass"]("layim-list-gray")},a4.prototype.content=function(a){return layui.data.content(a)};var aL=function(c){var b={friend:"该分组下暂无好友",group:"暂无群组",history:"暂无历史会话"};return c=c||{},c.item=c.item||"d."+c.type,["{{# var length = 0; layui.each("+c.item+", function(i, data){ length++; }}",'<li layim-event="chat" data-type="'+c.type+'" data-index="{{ '+(c.index||"i")+' }}" class="layim-'+("history"===c.type?"{{i}}":c.type+"{{data.id}}")+' {{ data.status === "offline" ? "layim-list-gray" : "" }}"><img src="{{ data.avatar }}"><span>{{ data.username||data.groupname||data.name||"佚名" }}</span><p>{{ data.remark||data.sign||"" }}</p><span class="layim-msg-status">new</span></li>',"{{# }); if(length === 0){ }}",'<li class="layim-null">'+(b[c.type]||"暂无数据")+"</li>","{{# } }}"].join("")},aH=['<div class="layui-layim-main">','<div class="layui-layim-info">','<div class="layui-layim-user">{{ d.mine.username }}</div>','<div class="layui-layim-status">','{{# if(d.mine.status === "online"){ }}','<span class="layui-icon layim-status-online" layim-event="status" lay-type="show">&#xe617;</span>','{{# } else if(d.mine.status === "hide") { }}','<span class="layui-icon layim-status-hide" layim-event="status" lay-type="show">&#xe60f;</span>',"{{# } }}",'<ul class="layui-anim layim-menu-box">','<li {{d.mine.status === "online" ? "class=layim-this" : ""}} layim-event="status" lay-type="online"><i class="layui-icon">&#xe618;</i><cite class="layui-icon layim-status-online">&#xe617;</cite>在线</li>','<li {{d.mine.status === "hide" ? "class=layim-this" : ""}} layim-event="status" lay-type="hide"><i class="layui-icon">&#xe618;</i><cite class="layui-icon layim-status-hide">&#xe60f;</cite>隐身</li>',"</ul>","</div>",'<input class="layui-layim-remark" placeholder="编辑签名" value="{{ d.mine.remark||d.mine.sign||"" }}">',"</div>",'<ul class="layui-unselect layui-layim-tab{{# if(!d.base.isfriend || !d.base.isgroup){ }}'," layim-tab-two",'{{# } }}">','<li class="layui-icon',"{{# if(!d.base.isfriend){ }}"," layim-hide","{{# } else { }}"," layim-this","{{# } }}",'" title="联系人" layim-event="tab" lay-type="friend">&#xe612;</li>','<li class="layui-icon',"{{# if(!d.base.isgroup){ }}"," layim-hide","{{# } else if(!d.base.isfriend) { }}"," layim-this","{{# } }}",'" title="群组" layim-event="tab" lay-type="group">&#xe613;</li>','<li class="layui-icon" title="历史会话" layim-event="tab" lay-type="history">&#xe611;</li>',"</ul>",'<ul class="layui-unselect layim-tab-content {{# if(d.base.isfriend){ }}layui-show{{# } }} layim-list-friend">','{{# layui.each(d.friend, function(index, item){ var spread = d.local["spread"+index]; }}',"<li>",'<h5 layim-event="spread" lay-type="{{ spread }}"><i class="layui-icon">{{# if(spread === "true"){ }}&#xe61a;{{# } else {  }}&#xe602;{{# } }}</i><span>{{ item.groupname||"未命名分组"+index }}</span><em>(<cite class="layim-count"> {{ (item.list||[]).length }}</cite>)</em></h5>','<ul class="layui-layim-list {{# if(spread === "true"){ }}'," layui-show",'{{# } }}">',aL({type:"friend",item:"item.list",index:"index"}),"</ul>","</li>","{{# }); if(d.friend.length === 0){ }}",'<li><ul class="layui-layim-list layui-show"><li class="layim-null">暂无联系人</li></ul>',"{{# } }}","</ul>",'<ul class="layui-unselect layim-tab-content {{# if(!d.base.isfriend && d.base.isgroup){ }}layui-show{{# } }}">',"<li>",'<ul class="layui-layim-list layui-show layim-list-group">',aL({type:"group"}),"</ul>","</li>","</ul>",'<ul class="layui-unselect layim-tab-content  {{# if(!d.base.isfriend && !d.base.isgroup){ }}layui-show{{# } }}">',"<li>",'<ul class="layui-layim-list layui-show layim-list-history">',aL({type:"history"}),"</ul>","</li>","</ul>",'<ul class="layui-unselect layim-tab-content">',"<li>",'<ul class="layui-layim-list layui-show" id="layui-layim-search"></ul>',"</li>","</ul>",'<ul class="layui-unselect layui-layim-tool">','<li class="layui-icon layim-tool-search" layim-event="search" title="搜索">&#xe615;</li>',"{{# if(d.base.msgbox){ }}",'<li class="layui-icon layim-tool-msgbox" layim-event="msgbox" title="消息盒子">&#xe645;<span class="layui-anim"></span></li>',"{{# } }}","{{# if(d.base.find){ }}",'<li class="layui-icon layim-tool-find" layim-event="find" title="查找">&#xe608;</li>',"{{# } }}",'<li class="layui-icon layim-tool-skin" layim-event="skin" title="更换背景">&#xe61b;</li>',"{{# if(!d.base.copyright){ }}",'<li class="layui-icon layim-tool-about" layim-event="about" title="关于">&#xe60b;</li>',"{{# } }}","</ul>",'<div class="layui-layim-search"><input><label class="layui-icon" layim-event="closeSearch">&#x1007;</label></div>',"</div>"].join(""),aT=['<ul class="layui-layim-skin">',"{{# layui.each(d.skin, function(index, item){ }}",'<li><img layim-event="setSkin" src="{{ item }}"></li>',"{{# }); }}",'<li layim-event="setSkin"><cite>简约</cite></li>',"</ul>"].join(""),a0=['<div class="layim-chat layim-chat-{{d.data.type}}{{d.first ? " layui-show" : ""}}">','<div class="layui-unselect layim-chat-title">','<div class="layim-chat-other">','<img class="layim-{{ d.data.type }}{{ d.data.id }}" src="{{ d.data.avatar }}"><span class="layim-chat-username" layim-event="{{ d.data.type==="group" ? "groupMembers" : "" }}">{{ d.data.name||"佚名" }} {{d.data.temporary ? "<cite>临时会话</cite>" : ""}} {{# if(d.data.type==="group"){ }} <em class="layim-chat-members"></em><i class="layui-icon">&#xe61a;</i> {{# } }}</span>','<p class="layim-chat-status"></p>',"</div>","</div>",'<div class="layim-chat-main">',"<ul></ul>","</div>",'<div class="layim-chat-footer">','<div class="layui-unselect layim-chat-tool" data-json="{{encodeURIComponent(JSON.stringify(d.data))}}">','<span class="layui-icon layim-tool-face" title="选择表情" layim-event="face">&#xe60c;</span>',"{{# if(d.base && d.base.uploadImage){ }}",'<span class="layui-icon layim-tool-image" title="上传图片" layim-event="image">&#xe60d;<input type="file" name="file"></span>',"{{# }; }}","{{# if(d.base && d.base.uploadFile){ }}",'<span class="layui-icon layim-tool-image" title="发送文件" layim-event="image" data-type="file">&#xe61d;<input type="file" name="file"></span>',"{{# }; }}","{{# if(d.base && d.base.isAudio){ }}",'<span class="layui-icon layim-tool-audio" title="发送网络音频" layim-event="media" data-type="audio">&#xe6fc;</span>',"{{# }; }}","{{# if(d.base && d.base.isVideo){ }}",'<span class="layui-icon layim-tool-video" title="发送网络视频" layim-event="media" data-type="video">&#xe6ed;</span>',"{{# }; }}","{{# layui.each(d.base.tool, function(index, item){ }}",'<span class="layui-icon layim-tool-{{item.alias}}" title="{{item.title}}" layim-event="extend" lay-filter="{{ item.alias }}">{{item.icon}}</span>',"{{# }); }}","{{# if(d.base && d.base.chatLog){ }}",'<span class="layim-tool-log" layim-event="chatLog"><i class="layui-icon">&#xe60e;</i>聊天记录</span>',"{{# }; }}","</div>",'<div class="layim-chat-textarea"><textarea></textarea></div>','<div class="layim-chat-bottom">','<div class="layim-chat-send">',"{{# if(!d.base.brief){ }}",'<span class="layim-send-close" layim-event="closeThisChat">关闭</span>',"{{# } }}",'<span class="layim-send-btn" layim-event="send">发送</span>','<span class="layim-send-set" layim-event="setSend" lay-type="show"><em class="layui-edge"></em></span>','<ul class="layui-anim layim-menu-box">','<li {{d.local.sendHotKey !== "Ctrl+Enter" ? "class=layim-this" : ""}} layim-event="setSend" lay-type="Enter"><i class="layui-icon">&#xe618;</i>按Enter键发送消息</li>','<li {{d.local.sendHotKey === "Ctrl+Enter" ? "class=layim-this" : ""}} layim-event="setSend"  lay-type="Ctrl+Enter"><i class="layui-icon">&#xe618;</i>按Ctrl+Enter键发送消息</li>',"</ul>","</div>","</div>","</div>","</div>"].join(""),aQ=['<div class="layim-add-box">','<div class="layim-add-img"><img class="layui-circle" src="{{ d.data.avatar }}"><p>{{ d.data.name||"" }}</p></div>','<div class="layim-add-remark">','{{# if(d.data.type === "friend" && d.type === "setGroup"){ }}',"<p>选择分组</p>",'{{# } if(d.data.type === "friend"){ }}','<select class="layui-select" id="LAY_layimGroup">',"{{# layui.each(d.data.group, function(index, item){ }}",'<option value="{{ item.id }}">{{ item.groupname }}</option>',"{{# }); }}","</select>","{{# } }}",'{{# if(d.data.type === "group"){ }}',"<p>请输入验证信息</p>",'{{# } if(d.type !== "setGroup"){ }}','<textarea id="LAY_layimRemark" placeholder="验证信息" class="layui-textarea"></textarea>',"{{# } }}","</div>","</div>"].join(""),aY=['<li {{ d.mine ? "class=layim-chat-mine" : "" }} {{# if(d.cid){ }}data-cid="{{d.cid}}"{{# } }}>','<div class="layim-chat-user"><img src="{{ d.avatar }}"><cite>',"{{# if(d.mine){ }}",'<i>{{ layui.data.date(d.timestamp) }}</i>{{ d.username||"佚名" }}',"{{# } else { }}",'{{ d.username||"佚名" }}<i>{{ layui.data.date(d.timestamp) }}</i>',"{{# } }}","</cite></div>",'<div class="layim-chat-text">{{ layui.data.content(d.content||"&nbsp") }}</div>',"</li>"].join(""),aK='<li class="layim-{{ d.data.type }}{{ d.data.id }} layim-chatlist-{{ d.data.type }}{{ d.data.id }} layim-this" layim-event="tabChat"><img src="{{ d.data.avatar }}"><span>{{ d.data.name||"佚名" }}</span>{{# if(!d.base.brief){ }}<i class="layui-icon" layim-event="closeChat">&#x1007;</i>{{# } }}</li>',aZ=function(a){return a<10?"0"+(0|a):a};layui.data.date=function(c){var b=new Date(c||new Date);return b.getFullYear()+"-"+aZ(b.getMonth()+1)+"-"+aZ(b.getDate())+" "+aZ(b.getHours())+":"+aZ(b.getMinutes())+":"+aZ(b.getSeconds())},layui.data.content=function(c){var b=function(a){return new RegExp("\\n*\\["+(a||"")+"(code|pre|div|span|p|table|thead|th|tbody|tr|td|ul|li|ol|li|dl|dt|dd|h2|h3|h4|h5)([\\s\\S]*?)\\]\\n*","g")};return c=(c||"").replace(/&(?!#?[a-zA-Z0-9]+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#39;").replace(/"/g,"&quot;").replace(/@(\S+)(\s+?|$)/g,'@<a href="javascript:;">$1</a>$2').replace(/face\[([^\s\[\]]+?)\]/g,function(e){var d=e.replace(/^face/g,"");return'<img alt="'+d+'" title="'+d+'" src="'+ad[d]+'">'}).replace(/img\[([^\s]+?)\]/g,function(a){return'<img class="layui-layim-photos" src="'+a.replace(/(^img\[)|(\]$)/g,"")+'">'}).replace(/file\([\s\S]+?\)\[[\s\S]*?\]/g,function(f){var d=(f.match(/file\(([\s\S]+?)\)\[/)||[])[1],g=(f.match(/\)\[([\s\S]*?)\]/)||[])[1];return d?'<a class="layui-layim-file" href="'+d+'" download target="_blank"><i class="layui-icon">&#xe61e;</i><cite>'+(g||d)+"</cite></a>":f}).replace(/audio\[([^\s]+?)\]/g,function(a){return'<div class="layui-unselect layui-layim-audio" layim-event="playAudio" data-src="'+a.replace(/(^audio\[)|(\]$)/g,"")+'"><i class="layui-icon">&#xe652;</i><p>音频消息</p></div>'}).replace(/video\[([^\s]+?)\]/g,function(a){return'<div class="layui-unselect layui-layim-video" layim-event="playVideo" data-src="'+a.replace(/(^video\[)|(\]$)/g,"")+'"><i class="layui-icon">&#xe652;</i></div>'}).replace(/a\([\s\S]+?\)\[[\s\S]*?\]/g,function(f){var d=(f.match(/a\(([\s\S]+?)\)\[/)||[])[1],g=(f.match(/\)\[([\s\S]*?)\]/)||[])[1];return d?'<a href="'+d+'" target="_blank">'+(g||d)+"</a>":f}).replace(b(),"<$1 $2>").replace(b("/"),"</$1>").replace(/\n/g,"<br>")};var aI,a5,aJ,aV,aB,aj=function(c,b,d){return c=c||{},a2.ajax({url:c.url,type:c.type||"get",data:c.data,dataType:c.dataType||"json",cache:!1,success:function(a){0==a.code?b&&b(a.data||{}):aM.msg(a.msg||(d||"Error")+": LAYIM_NOT_GET_DATA",{time:5000})},error:function(f,e){window.console&&console.log&&console.error("LAYIM_DATE_ERROR："+e)}})},aW={message:{},chat:[]},aw=function(c){var b=c.init||{};return mine=b.mine||{},local=layui.data("layim")[mine.id]||{},obj={base:c,local:local,mine:mine,history:local.history||{}},create=function(e){var f=e.mine||{},d=layui.data("layim")[f.id]||{},g={base:c,local:d,mine:f,friend:e.friend||[],group:e.group||[],history:d.history||{}};aW=a2.extend(aW,g),aq(aS(aH).render(g)),(d.close||c.min)&&ah(),layui.each(aO.ready,function(j,h){h&&h(g)})},aW=a2.extend(aW,obj),c.brief?layui.each(aO.ready,function(e,d){d&&d(obj)}):void (b.url?aj(b,create,"INIT"):create(b))},aq=function(a){return aM.open({type:1,area:["260px","520px"],skin:"layui-box layui-layim",title:"&#8203;",offset:"rb",id:"layui-layim",shade:!1,anim:2,resize:!1,content:a,success:function(c){aI=c,ak(c),aW.base.right&&c.css("margin-left","-"+aW.base.right),a5&&aM.close(a5.attr("times"));var b=[],d=c.find(".layim-list-history");d.find("li").each(function(){b.push(a2(this).prop("outerHTML"))}),b.length>0&&(b.reverse(),d.html(b.join(""))),aD(),aa.sign()},cancel:function(c){ah();var b=layui.data("layim")[aW.mine.id]||{};return b.close=!0,layui.data("layim",{key:aW.mine.id,value:b}),!1}})},aD=function(){aI.on("contextmenu",function(b){return b.cancelBubble=!0,b.returnValue=!1,!1});var a=function(){aM.closeAll("tips")};aI.find(".layim-list-history").on("contextmenu","li",function(c){var d=a2(this),b='<ul data-id="'+d[0].id+'" data-index="'+d.data("index")+'"><li layim-event="menuHistory" data-type="one">移除该会话</li><li layim-event="menuHistory" data-type="all">清空全部会话列表</li></ul>';d.hasClass("layim-null")||(aM.tips(b,this,{tips:1,time:0,anim:5,fixed:!0,skin:"layui-box layui-layim-contextmenu",success:function(f){var e=function(g){aF(g)};f.off("mousedown",e).on("mousedown",e)}}),a2(document).off("mousedown",a).on("mousedown",a),a2(window).off("resize",a).on("resize",a))})},ah=function(a){return a5&&aM.close(a5.attr("times")),aI&&aI.hide(),aW.mine=aW.mine||{},aM.open({type:1,title:!1,id:"layui-layim-close",skin:"layui-box layui-layim-min layui-layim-close",shade:!1,closeBtn:!1,anim:2,offset:"rb",resize:!1,content:'<img src="'+(aW.mine.avatar||layui.cache.dir+"css/pc/layim/skin/logo.jpg")+'"><span>'+(a||aW.base.title||"我的LayIM")+"</span>",move:"#layui-layim-close img",success:function(c,b){a5=c,aW.base.right&&c.css("margin-left","-"+aW.base.right),c.on("click",function(){aM.close(b),aI.show();var d=layui.data("layim")[aW.mine.id]||{};delete d.close,layui.data("layim",{key:aW.mine.id,value:d})})}})},aG=function(g){g=g||{};var e=a2("#layui-layim-chat"),b={data:g,base:aW.base,local:aW.local};if(!g.id){return aM.msg("非法用户")}if(e[0]){var h=aJ.find(".layim-chat-list"),k=h.find(".layim-chatlist-"+g.type+g.id),j=aJ.find(".layui-layer-max").hasClass("layui-layer-maxmin"),m=e.children(".layim-chat-box");return"none"===aJ.css("display")&&aJ.show(),aV&&aM.close(aV.attr("times")),1!==h.find("li").length||k[0]||(j||aJ.css("width",800),h.css({height:aJ.height()}).show(),m.css("margin-left","200px")),k[0]||(h.append(aS(aK).render(b)),m.append(aS(a0).render(b)),au(g),az()),an(h.find(".layim-chatlist-"+g.type+g.id)),k[0]||am(),aE(g),al(),aB}b.first=!0;var f=aB=aM.open({type:1,area:"600px",skin:"layui-box layui-layim-chat",id:"layui-layim-chat",title:"&#8203;",shade:!1,maxmin:!0,offset:g.offset||"auto",anim:g.anim||0,closeBtn:!aW.base.brief&&1,content:aS('<ul class="layui-unselect layim-chat-list">'+aK+'</ul><div class="layim-chat-box">'+a0+"</div>").render(b),success:function(c){aJ=c,c.css({"min-width":"500px","min-height":"420px"}),au(g),"function"==typeof g.success&&g.success(c),al(),ak(c),aE(g),am(),aP(),layui.each(aO.chatChange,function(l,d){d&&d(a7())}),c.on("dblclick",".layui-layim-photos",function(){var a=this.src;aM.close(aG.photosIndex),aM.photos({photos:{data:[{alt:"大图模式",src:a}]},shade:0.01,closeBtn:2,anim:0,resize:!1,success:function(l,d){aG.photosIndex=d}})})},full:function(a){aM.style(f,{width:"100%",height:"100%"},!0),az()},resizing:az,restore:az,min:function(){return ao(),!1},end:function(){aM.closeAll("tips"),aJ=null}});return f},au=function(a){a2(".layim-"+a.type+a.id).each(function(){a2(this).hasClass("layim-list-gray")&&layui.layim.setFriendStatus(a.id,"offline")})},az=function(){var c=aJ.find(".layim-chat-list"),b=aJ.find(".layim-chat-main"),d=aJ.height();c.css({height:d}),b.css({height:d-20-80-158})},ao=function(c){var b=c||a7().data,d=layui.layim.cache().base;aJ&&!c&&aJ.hide(),aM.close(ao.index),ao.index=aM.open({type:1,title:!1,skin:"layui-box layui-layim-min",shade:!1,closeBtn:!1,anim:b.anim||2,offset:"b",move:"#layui-layim-min",resize:!1,area:["182px","50px"],content:'<img id="layui-layim-min" src="'+b.avatar+'"><span>'+b.name+"</span>",success:function(f,e){c||(aV=f),d.minRight&&aM.style(e,{left:a2(window).width()-f.outerWidth()-parseFloat(d.minRight)}),f.find(".layui-layer-content span").on("click",function(){aM.close(e),c?layui.each(aW.chat,function(h,g){aG(g)}):aJ.show(),c&&(aW.chat=[],ab())}),f.find(".layui-layer-content img").on("click",function(a){aF(a)})}})},ap=function(c,b){return c=c||{},aM.close(ap.index),ap.index=aM.open({type:1,area:"430px",title:{friend:"添加好友",group:"加入群组"}[c.type]||"",shade:!1,resize:!1,btn:b?["确认","取消"]:["发送申请","关闭"],content:aS(aQ).render({data:{name:c.username||c.groupname,avatar:c.avatar,group:c.group||parent.layui.layim.cache().friend||[],type:c.type},type:b}),yes:function(f,d){var g=d.find("#LAY_layimGroup"),a=d.find("#LAY_layimRemark");b?c.submit&&c.submit(g.val(),f):c.submit&&c.submit(g.val(),a.val(),f)}})},an=function(g,e){g=g||a2(".layim-chat-list ."+aR);var k=g.index()===-1?0:g.index(),b=".layim-chat",h=aJ.find(b).eq(k),j=aJ.find(".layui-layer-max").hasClass("layui-layer-maxmin");if(e){g.hasClass(aR)&&an(0===k?g.next():g.prev());var f=aJ.find(b).length;return 1===f?aM.close(aB):(g.remove(),h.remove(),2===f&&(aJ.find(".layim-chat-list").hide(),j||aJ.css("width","600px"),aJ.find(".layim-chat-box").css("margin-left",0)),!1)}g.addClass(aR).siblings().removeClass(aR),h.addClass(aN).siblings(b).removeClass(aN),h.find("textarea").focus(),layui.each(aO.chatChange,function(d,c){c&&c(a7())}),aP()},aP=function(){var c=a7(),b=aW.message[c.data.type+c.data.id];b&&delete aW.message[c.data.type+c.data.id]},a7=function(){if(aJ){var d=a2(".layim-chat-list ."+aR).index(),b=aJ.find(".layim-chat").eq(d),c=JSON.parse(decodeURIComponent(b.find(".layim-chat-tool").data("json")));return{elem:b,data:c,textarea:b.find("textarea")}}},ak=function(c){var b=layui.data("layim")[aW.mine.id]||{},d=b.skin;c.css({"background-image":d?"url("+d+")":function(){return aW.base.initSkin?"url("+(layui.cache.dir+"css/modules/layim/skin/"+aW.base.initSkin)+")":"none"}()})},aE=function(f){var c=layui.data("layim")[aW.mine.id]||{},h={},d=c.history||{},b=d[f.type+f.id];if(aI){var g=aI.find(".layim-list-history");if(f.historyTime=(new Date).getTime(),d[f.type+f.id]=f,c.history=d,layui.data("layim",{key:aW.mine.id,value:c}),!b){h[f.type+f.id]=f;var j=aS(aL({type:"history",item:"d.data"})).render({data:h});g.prepend(j),g.find(".layim-null").remove()}}},aA=function(){var d={username:aW.mine?aW.mine.username:"访客",avatar:aW.mine?aW.mine.avatar:layui.cache.dir+"css/pc/layim/skin/logo.jpg",id:aW.mine?aW.mine.id:null,mine:!0},c=a7(),g=c.elem.find(".layim-chat-main ul"),b=aW.base.maxLength||3000;if(d.content=c.textarea.val(),""!==d.content.replace(/\s/g,"")){if(d.content.length>b){return aM.msg("内容最长不能超过"+b+"个字符")}g.append(aS(aY).render(d));var f={mine:d,to:c.data},h={username:f.mine.username,avatar:f.mine.avatar,id:f.to.id,type:f.to.type,content:f.mine.content,timestamp:(new Date).getTime(),mine:!0};aC(h),layui.each(aO.sendMessage,function(j,e){e&&e(f)})}ab(),c.textarea.val("").focus()},at=function(a){if(a=a||{},window.Notification){if("granted"===Notification.permission){new Notification(a.title||"",{body:a.content||"",icon:a.avatar||"http://tp2.sinaimg.cn/5488749285/50/5719808192/1"})}else{Notification.requestPermission()}}},ay=function(){if(!(aU.ie&&aU.ie<9)){var a=document.createElement("audio");a.src=layui.cache.dir+"css/modules/layim/voice/"+aW.base.voice,a.play()}},ax={},ar=function(g){g=g||{};var k=a2(".layim-chatlist-"+g.type+g.id),m={},f=k.index();if(g.timestamp=g.timestamp||(new Date).getTime(),g.fromid==aW.mine.id&&(g.mine=!0),g.system||aC(g),ax=JSON.parse(JSON.stringify(g)),aW.base.voice&&ay(),!aJ&&g.content||f===-1){if(aW.message[g.type+g.id]){aW.message[g.type+g.id].push(g)}else{if(aW.message[g.type+g.id]=[g],"friend"===g.type){var n;layui.each(aW.friend,function(c,d){if(layui.each(d.list,function(i,l){if(l.id==g.id){return l.type="friend",l.name=l.username,aW.chat.push(l),n=!0}}),n){return !0}}),n||(g.name=g.username,g.temporary=!0,aW.chat.push(g))}else{if("group"===g.type){var e;layui.each(aW.group,function(c,d){if(d.id==g.id){return d.type="group",d.name=d.groupname,aW.chat.push(d),e=!0}}),e||(g.name=g.groupname,aW.chat.push(g))}else{g.name=g.name||g.username||g.groupname,aW.chat.push(g)}}}if("group"===g.type&&layui.each(aW.group,function(c,d){if(d.id==g.id){return m.avatar=d.avatar,!0}}),!g.system){return aW.base.notice&&at({title:"来自 "+g.username+" 的消息",content:g.content,avatar:m.avatar||g.avatar}),ao({name:"收到新消息",avatar:m.avatar||g.avatar,anim:6})}}if(aJ){var h=a7();h.data.type+h.data.id!==g.type+g.id&&(k.addClass("layui-anim layer-anim-06"),setTimeout(function(){k.removeClass("layui-anim layer-anim-06")},300));var b=aJ.find(".layim-chat").eq(f),j=b.find(".layim-chat-main ul");g.system?f!==-1&&j.append('<li class="layim-chat-system"><span>'+g.content+"</span></li>"):""!==g.content.replace(/\s/g,"")&&j.append(aS(aY).render(g)),ab()}},ac="layui-anim-loop layer-anim-05",af=function(c){var b=aI.find(".layim-tool-msgbox");b.find("span").addClass(ac).html(c)},aC=function(d){var b=layui.data("layim")[aW.mine.id]||{};b.chatlog=b.chatlog||{};var f=b.chatlog[d.type+d.id];if(f){var c;layui.each(f,function(g,h){h.timestamp===d.timestamp&&h.type===d.type&&h.id===d.id&&h.content===d.content&&(c=!0)}),c||d.fromid==aW.mine.id||f.push(d),f.length>a3&&f.shift()}else{b.chatlog[d.type+d.id]=[d]}layui.data("layim",{key:aW.mine.id,value:b})},am=function(){var d=layui.data("layim")[aW.mine.id]||{},b=a7(),f=d.chatlog||{},c=b.elem.find(".layim-chat-main ul");layui.each(f[b.data.type+b.data.id],function(g,e){c.append(aS(aY).render(e))}),ab()},ag=function(d){var c,g={},b=aI.find(".layim-list-"+d.type);if(aW[d.type]){if("friend"===d.type){layui.each(aW.friend,function(e,a){if(d.groupid==a.id){return layui.each(aW.friend[e].list,function(j,i){if(i.id==d.id){return c=!0}}),c?aM.msg("好友 ["+(d.username||"")+"] 已经存在列表中",{anim:6}):(aW.friend[e].list=aW.friend[e].list||[],g[aW.friend[e].list.length]=d,d.groupIndex=e,aW.friend[e].list.push(d),!0)}})}else{if("group"===d.type){if(layui.each(aW.group,function(i,a){if(a.id==d.id){return c=!0}}),c){return aM.msg("您已是 ["+(d.groupname||"")+"] 的群成员",{anim:6})}g[aW.group.length]=d,aW.group.push(d)}}}if(!c){var f=aS(aL({type:d.type,item:"d.data",index:"friend"===d.type?"data.groupIndex":null})).render({data:g});if("friend"===d.type){var h=b.find(">li").eq(d.groupIndex);h.find(".layui-layim-list").append(f),h.find(".layim-count").html(aW.friend[d.groupIndex].list.length),h.find(".layim-null")[0]&&h.find(".layim-null").remove()}else{"group"===d.type&&(b.append(f),b.find(".layim-null")[0]&&b.find(".layim-null").remove())}}},ae=function(c){var b=aI.find(".layim-list-"+c.type);aW[c.type]&&("friend"===c.type?layui.each(aW.friend,function(d,a){layui.each(a.list,function(f,g){if(c.id==g.id){var e=b.find(">li").eq(d);e.find(".layui-layim-list>li");return e.find(".layui-layim-list>li").eq(f).remove(),aW.friend[d].list.splice(f,1),e.find(".layim-count").html(aW.friend[d].list.length),0===aW.friend[d].list.length&&e.find(".layui-layim-list").html('<li class="layim-null">该分组下已无好友了</li>'),!0}})}):"group"===c.type&&layui.each(aW.group,function(d,a){if(c.id==a.id){return b.find(">li").eq(d).remove(),aW.group.splice(d,1),0===aW.group.length&&b.html('<li class="layim-null">暂无群组</li>'),!0}}))},ab=function(){var d=a7(),b=d.elem.find(".layim-chat-main"),f=b.find("ul"),c=f.find("li").length;if(c>=a3){var g=f.find("li").eq(0);f.prev().hasClass("layim-chat-system")||f.before('<div class="layim-chat-system"><span layim-event="chatLog">查看更多记录</span></div>'),c>a3&&g.remove()}b.scrollTop(b[0].scrollHeight+1000),b.find("ul li:last").find("img").load(function(){b.scrollTop(b[0].scrollHeight+1000)})},al=function(){var c=a7(),b=c.textarea;b.focus(),b.off("keydown").on("keydown",function(d){var f=layui.data("layim")[aW.mine.id]||{},a=d.keyCode;if("Ctrl+Enter"===f.sendHotKey){return void (d.ctrlKey&&13===a&&aA())}if(13===a){if(d.ctrlKey){return b.val(b.val()+"\n")}if(d.shiftKey){return}d.preventDefault(),aA()}})},ad=function(){var c=["[微笑]","[嘻嘻]","[哈哈]","[可爱]","[可怜]","[挖鼻]","[吃惊]","[害羞]","[挤眼]","[闭嘴]","[鄙视]","[爱你]","[泪]","[偷笑]","[亲亲]","[生病]","[太开心]","[白眼]","[右哼哼]","[左哼哼]","[嘘]","[衰]","[委屈]","[吐]","[哈欠]","[抱抱]","[怒]","[疑问]","[馋嘴]","[拜拜]","[思考]","[汗]","[困]","[睡]","[钱]","[失望]","[酷]","[色]","[哼]","[鼓掌]","[晕]","[悲伤]","[抓狂]","[黑线]","[阴险]","[怒骂]","[互粉]","[心]","[伤心]","[猪头]","[熊猫]","[兔子]","[ok]","[耶]","[good]","[NO]","[赞]","[来]","[弱]","[草泥马]","[神马]","[囧]","[浮云]","[给力]","[围观]","[威武]","[奥特曼]","[礼物]","[钟]","[话筒]","[蜡烛]","[蛋糕]"],b={};return layui.each(c,function(a,d){b[d]=layui.cache.dir+"images/face/"+a+".gif"}),b}(),aF=layui.stope,av=function(d,b){var f,c=d.value;d.focus(),document.selection?(f=document.selection.createRange(),document.selection.empty(),f.text=b):(f=[c.substring(0,d.selectionStart),b,c.substr(d.selectionEnd)],d.focus(),d.value=f.join(""))},a1="layui-anim-upbit",aa={status:function(e,c){var d=function(){e.next().hide().removeClass(a1)},f=e.attr("lay-type");if("show"===f){aF(c),e.next().show().addClass(a1),a2(document).off("click",d).on("click",d)}else{var b=e.parent().prev();e.addClass(aR).siblings().removeClass(aR),b.html(e.find("cite").html()),b.removeClass("layim-status-"+("online"===f?"hide":"online")).addClass("layim-status-"+f),layui.each(aO.online,function(h,g){g&&g(f)})}},sign:function(){var a=aI.find(".layui-layim-remark");a.on("change",function(){var b=this.value;layui.each(aO.sign,function(c,d){d&&d(b)})}),a.on("keyup",function(c){var b=c.keyCode;13===b&&this.blur()})},tab:function(d){var b,f=".layim-tab-content",c=aI.find(".layui-layim-tab>li");"number"==typeof d?(b=d,d=c.eq(b)):b=d.index(),b>2?c.removeClass(aR):(aa.tab.index=b,d.addClass(aR).siblings().removeClass(aR)),aI.find(f).eq(b).addClass(aN).siblings(f).removeClass(aN)},spread:function(d){var b=d.attr("lay-type"),f="true"===b?"false":"true",c=layui.data("layim")[aW.mine.id]||{};d.next()["true"===b?"removeClass":"addClass"](aN),c["spread"+d.parent().index()]=f,layui.data("layim",{key:aW.mine.id,value:c}),d.attr("lay-type",f),d.find(".layui-icon").html("true"===f?"&#xe61a;":"&#xe602;")},search:function(d){var b=aI.find(".layui-layim-search"),f=aI.find("#layui-layim-search"),c=b.find("input"),g=function(m){var t=c.val().replace(/\s/);if(""===t){aa.tab(0|aa.tab.index)}else{for(var j=[],k=aW.friend||[],w=aW.group||[],h="",p=0;p<k.length;p++){for(var e=0;e<(k[p].list||[]).length;e++){k[p].list[e].username.indexOf(t)!==-1&&(k[p].list[e].type="friend",k[p].list[e].index=p,k[p].list[e].list=e,j.push(k[p].list[e]))}}for(var q=0;q<w.length;q++){w[q].groupname.indexOf(t)!==-1&&(w[q].type="group",w[q].index=q,w[q].list=q,j.push(w[q]))}if(j.length>0){for(var v=0;v<j.length;v++){h+='<li layim-event="chat" data-type="'+j[v].type+'" data-index="'+j[v].index+'" data-list="'+j[v].list+'"><img src="'+j[v].avatar+'"><span>'+(j[v].username||j[v].groupname||"佚名")+"</span><p>"+(j[v].remark||j[v].sign||"")+"</p></li>"}}else{h='<li class="layim-null">无搜索结果</li>'}f.html(h),aa.tab(3)}};!aW.base.isfriend&&aW.base.isgroup?aa.tab.index=1:aW.base.isfriend||aW.base.isgroup||(aa.tab.index=2),b.show(),c.focus(),c.off("keyup",g).on("keyup",g)},closeSearch:function(a){a.parent().hide(),aa.tab(0|aa.tab.index)},msgbox:function(){var a=aI.find(".layim-tool-msgbox");return aM.close(aa.msgbox.index),a.find("span").removeClass(ac).html(""),aa.msgbox.index=aM.open({type:2,title:"消息盒子",shade:!1,maxmin:!0,area:["600px","520px"],skin:"layui-box layui-layer-border",resize:!1,content:aW.base.msgbox})},find:function(){return aM.close(aa.find.index),aa.find.index=aM.open({type:2,title:"查找",shade:!1,maxmin:!0,area:["1000px","520px"],skin:"layui-box layui-layer-border",resize:!1,content:aW.base.find})},skin:function(){aM.open({type:1,title:"更换背景",shade:!1,area:"300px",skin:"layui-box layui-layer-border",id:"layui-layim-skin",zIndex:66666666,resize:!1,content:aS(aT).render({skin:aW.base.skin})})},about:function(){aM.alert("版本： "+a6+'<br>版权所有：<a href="http://layim.layui.com" target="_blank">layim.layui.com</a>',{title:"关于 LayIM",shade:!1})},setSkin:function(d){var b=d.attr("src"),f=layui.data("layim")[aW.mine.id]||{};f.skin=b,b||delete f.skin,layui.data("layim",{key:aW.mine.id,value:f});try{aI.css({"background-image":b?"url("+b+")":"none"}),aJ.css({"background-image":b?"url("+b+")":"none"})}catch(c){}layui.each(aO.setSkin,function(g,h){var a=(b||"").replace(layui.cache.dir+"css/modules/layim/skin/","");h&&h(a,b)})},chat:function(f){var c=layui.data("layim")[aW.mine.id]||{},g=f.data("type"),d=f.data("index"),h=f.attr("data-list")||f.index(),b={};"friend"===g?b=aW[g][d].list[h]:"group"===g?b=aW[g][h]:"history"===g&&(b=(c.history||{})[d]||{}),b.name=b.name||b.username||b.groupname,"history"!==g&&(b.type=g),aG(b)},tabChat:function(a){an(a)},closeChat:function(c,b){an(c.parent(),1),aF(b)},closeThisChat:function(){an(null,1)},groupMembers:function(d,c){var f=d.find(".layui-icon"),b=function(){f.html("&#xe61a;"),d.data("down",null),aM.close(aa.groupMembers.index)},e=function(a){aF(a)};d.data("down")?b():(f.html("&#xe619;"),d.data("down",!0),aa.groupMembers.index=aM.tips('<ul class="layim-members-list"></ul>',d,{tips:3,time:0,anim:5,fixed:!0,skin:"layui-box layui-layim-members",success:function(g){var i=aW.base.members||{},p=a7(),j=g.find(".layim-members-list"),l="",k={},m=aJ.find(".layui-layer-max").hasClass("layui-layer-maxmin"),h="none"===aJ.find(".layim-chat-list").css("display");m&&j.css({width:a2(window).width()-22-(h||200)}),i.data=a2.extend(i.data,{id:p.data.id}),aj(i,function(n){layui.each(n.list,function(q,o){l+='<li data-uid="'+o.id+'"><a href="javascript:;"><img src="'+o.avatar+'"><cite>'+o.username+"</cite></a></li>",k[o.id]=o}),j.html(l),d.find(".layim-chat-members").html(n.members||(n.list||[]).length+"人"),j.find("li").on("click",function(){var q=a2(this).data("uid"),o=k[q];aG({name:o.username,type:"friend",avatar:o.avatar,id:o.id}),b()}),layui.each(aO.members,function(a,o){o&&o(n)})}),g.on("mousedown",function(a){aF(a)})}}),a2(document).off("mousedown",b).on("mousedown",b),a2(window).off("resize",b).on("resize",b),d.off("mousedown",e).on("mousedown",e))},send:function(){aA()},setSend:function(e,c){var d=aa.setSend.box=e.siblings(".layim-menu-box"),f=e.attr("lay-type");if("show"===f){aF(c),d.show().addClass(a1),a2(document).off("click",aa.setSendHide).on("click",aa.setSendHide)}else{e.addClass(aR).siblings().removeClass(aR);var b=layui.data("layim")[aW.mine.id]||{};b.sendHotKey=f,layui.data("layim",{key:aW.mine.id,value:b}),aa.setSendHide(c,e.parent())}},setSendHide:function(c,b){(b||aa.setSend.box).hide().removeClass(a1)},face:function(d,c){var f="",b=a7();for(var e in ad){f+='<li title="'+e+'"><img src="'+ad[e]+'"></li>'}f='<ul class="layui-clear layim-face-list">'+f+"</ul>",aa.face.index=aM.tips(f,d,{tips:1,time:0,fixed:!0,skin:"layui-box layui-layim-face",success:function(a){a.find(".layim-face-list>li").on("mousedown",function(g){aF(g)}).on("click",function(){av(b.textarea[0],"face"+this.title+" "),aM.close(aa.face.index)})}}),a2(document).off("mousedown",aa.faceHide).on("mousedown",aa.faceHide),a2(window).off("resize",aa.faceHide).on("resize",aa.faceHide),aF(c)},faceHide:function(){aM.close(aa.face.index)},image:function(d){var c=d.data("type")||"images",f={images:"uploadImage",file:"uploadFile"},g=a7(),b=aW.base[f[c]]||{};layui.upload.render({url:b.url||"",method:b.type,elem:d.find("input")[0],type:c,done:function(a){0==a.code?(a.data=a.data||{},"images"===c?av(g.textarea[0],"img["+(a.data.src||"")+"]"):"file"===c&&av(g.textarea[0],"file("+(a.data.src||"")+")["+(a.data.name||"下载文件")+"]"),aA()):aM.msg(a.msg||"上传失败")}})},media:function(d){var c=d.data("type"),e={audio:"音频",video:"视频"},b=a7();aM.prompt({title:"请输入网络"+e[c]+"地址",shade:!1,offset:[d.offset().top-a2(window).scrollTop()-158+"px",d.offset().left+"px"]},function(a,f){av(b.textarea[0],c+"["+a+"]"),aA(),aM.close(f)})},extend:function(c){var b=c.attr("lay-filter"),d=a7();layui.each(aO["tool("+b+")"],function(e,f){f&&f.call(c,function(a){av(d.textarea[0],a)},aA,d)})},playAudio:function(c){var b=c.data("audio"),d=b||document.createElement("audio"),f=function(){d.pause(),c.removeAttr("status"),c.find("i").html("&#xe652;")};return c.data("error")?aM.msg("播放音频源异常"):d.play?void (c.attr("status")?f():(b||(d.src=c.data("src")),d.play(),c.attr("status","pause"),c.data("audio",d),c.find("i").html("&#xe651;"),d.onended=function(){f()},d.onerror=function(){aM.msg("播放音频源异常"),c.data("error",!0),f()})):aM.msg("您的浏览器不支持audio")},playVideo:function(c){var b=c.data("src"),d=document.createElement("video");return d.play?(aM.close(aa.playVideo.index),void (aa.playVideo.index=aM.open({type:1,title:"播放视频",area:["460px","300px"],maxmin:!0,shade:!1,content:'<div style="background-color: #000; height: 100%;"><video style="position: absolute; width: 100%; height: 100%;" src="'+b+'" loop="loop" autoplay="autoplay"></video></div>'}))):aM.msg("您的浏览器不支持video")},chatLog:function(c){var b=a7();return aW.base.chatLog?(aM.close(aa.chatLog.index),aa.chatLog.index=aM.open({type:2,maxmin:!0,title:"与 "+b.data.name+" 的聊天记录",area:["450px","100%"],shade:!1,offset:"rb",skin:"layui-box",anim:2,id:"layui-layim-chatlog",content:aW.base.chatLog+"?id="+b.data.id+"&type="+b.data.type})):aM.msg("未开启更多聊天记录")},menuHistory:function(e,c){var k=layui.data("layim")[aW.mine.id]||{},b=e.parent(),f=e.data("type"),j=aI.find(".layim-list-history"),h='<li class="layim-null">暂无历史会话</li>';if("one"===f){var g=k.history;delete g[b.data("index")],k.history=g,layui.data("layim",{key:aW.mine.id,value:k}),a2("#"+b.data("id")).remove(),0===j.find("li").length&&j.html(h)}else{"all"===f&&(delete k.history,layui.data("layim",{key:aW.mine.id,value:k}),j.html(h))}aM.closeAll("tips")}};aX("layim",new a4)}).addcss("modules/layim/layim.css?v=3.60Pro","skinlayimcss");