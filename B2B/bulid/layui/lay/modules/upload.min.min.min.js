layui.define("layer",function(w){var q=layui.$,d=layui.layer,k=layui.hint(),y=layui.device(),j={config:{},set:function(c){var a=this;return a.config=q.extend({},a.config,c),a},on:function(c,a){return layui.onevent.call(this,b,c,a)}},m=function(){var a=this;return{upload:function(c){a.upload.call(a,c)},config:a.config}},b="upload",z="layui-upload-file",x="layui-upload-form",g="layui-upload-iframe",v="layui-upload-choose",h=function(c){var a=this;a.config=q.extend({},a.config,j.config,c),a.render()};h.prototype.config={accept:"images",exts:"",auto:!0,bindAction:"",url:"",field:"file",method:"post",data:{},drag:!0,size:0,multiple:!1},h.prototype.render=function(c){var a=this,c=a.config;c.elem=q(c.elem),c.bindAction=q(c.bindAction),a.file(),a.events()},h.prototype.file=function(){var c=this,a=c.config,f=c.elemFile=q(['<input class="'+z+'" type="file" name="'+a.field+'"',a.multiple?" multiple":"",">"].join("")),e=a.elem.next();(e.hasClass(z)||e.hasClass(x))&&e.remove(),y.ie&&y.ie<10&&a.elem.wrap('<div class="layui-upload-wrap"></div>'),c.isFile()?(c.elemFile=a.elem,a.field=a.elem[0].name):a.elem.after(f),y.ie&&y.ie<10&&c.initIE()},h.prototype.initIE=function(){var f=this,e=f.config,a=q('<iframe id="'+g+'" class="'+g+'" name="'+g+'" frameborder="0"></iframe>'),c=q(['<form target="'+g+'" class="'+x+'" method="'+e.method,'" key="set-mine" enctype="multipart/form-data" action="'+e.url+'">',"</form>"].join(""));q("#"+g)[0]||q("body").append(a),e.elem.next().hasClass(g)||(f.elemFile.wrap(c),e.elem.next("."+g).append(function(){var i=[];return layui.each(e.data,function(l,n){i.push('<input type="hidden" name="'+l+'" value="'+n+'">')}),i.join("")}()))},h.prototype.msg=function(a){return d.msg(a,{icon:2,shift:6})},h.prototype.isFile=function(){var a=this.config.elem[0];if(a){return"input"===a.tagName.toLocaleLowerCase()&&"file"===a.type}},h.prototype.preview=function(c){var a=this;window.FileReader&&layui.each(a.chooseFiles,function(f,e){var i=new FileReader;i.readAsDataURL(e),i.onload=function(){c&&c(f,e,this.result)}})},h.prototype.upload=function(n,a){var e,c=this,p=c.config,u=c.elemFile[0],t=function(){layui.each(n||c.files||c.chooseFiles||u.files,function(D,E){var F=new FormData;F.append(p.field,E),layui.each(p.data,function(G,C){F.append(G,C)}),q.ajax({url:p.url,type:p.method,data:F,contentType:!1,processData:!1,dataType:"json",success:function(C){s(D,C)},error:function(){c.msg("请求上传接口出现异常"),i(D)}})})},B=function(){var C=q("#"+g);c.elemFile.parent().submit(),clearInterval(h.timer),h.timer=setInterval(function(){var G,F=C.contents().find("body");try{G=F.text()}catch(E){c.msg("获取上传后的响应信息出现异常"),clearInterval(h.timer),i()}G&&(clearInterval(h.timer),F.html(""),s(0,G))},30)},s=function(E,D){if(c.elemFile.next("."+v).remove(),u.value="","object"!=typeof D){try{D=JSON.parse(D)}catch(F){return D={},c.msg("请对上传接口返回有效JSON")}}"function"==typeof p.done&&p.done(D,E||0,function(C){c.upload(C)})},i=function(C){p.auto&&(u.value=""),"function"==typeof p.error&&p.error(C||0,function(D){c.upload(D)})},r=p.exts,f=function(){var C=[];return layui.each(n||c.chooseFiles,function(D,E){C.push(E.name)}),C}(),l={preview:function(C){c.preview(C)},upload:function(E,D){var F={};F[E]=D,c.upload(F)},pushFile:function(){return c.files=c.files||{},layui.each(c.chooseFiles,function(C,D){c.files[C]=D}),c.files}},o=function(){return"choose"===a?p.choose&&p.choose(l):(p.before&&p.before(l),y.ie?y.ie>9?t():B():void t())};switch(f=0===f.length?u.value.match(/[^\/\\]+\..+/g)||[]||"":f,p.accept){case"file":if(r&&!RegExp("\\w\\.("+r+")$","i").test(escape(f))){return c.msg("选择的文件中包含不支持的格式"),u.value=""}break;case"video":if(!RegExp("\\w\\.("+(r||"avi|mp4|wma|rmvb|rm|flash|3gp|flv")+")$","i").test(escape(f))){return c.msg("选择的视频中包含不支持的格式"),u.value=""}break;case"audio":if(!RegExp("\\w\\.("+(r||"mp3|wav|mid")+")$","i").test(escape(f))){return c.msg("选择的音频中包含不支持的格式"),u.value=""}break;default:if(layui.each(f,function(C,D){RegExp("\\w\\.("+(r||"jpg|png|gif|bmp|jpeg$")+")","i").test(escape(D))||(e=!0)}),e){return c.msg("选择的图片中包含不支持的格式"),u.value=""}}if(p.size>0&&!(y.ie&&y.ie<10)){var A;if(layui.each(c.chooseFiles,function(E,D){if(D.size>1024*p.size){var F=p.size/1024;F=F>=1?Math.floor(F)+(F%1>0?F.toFixed(1):0)+"MB":p.size+"KB",u.value="",A=F}}),A){return c.msg("文件不能超过"+A)}}o()},h.prototype.events=function(){var e=this,c=e.config,f=function(i){e.chooseFiles={},layui.each(i,function(o,n){var l=(new Date).getTime();e.chooseFiles[l+"-"+o]=n})},a=function(n,l){var o=e.elemFile,i=n.length>1?n.length+"个文件":(n[0]||{}).name||o[0].value.match(/[^\/\\]+\..+/g)||[]||"";o.next().hasClass(v)&&o.next().remove(),e.upload(null,"choose"),e.isFile()||c.choose||o.after('<span class="layui-inline '+v+'">'+i+"</span>")};c.elem.off("upload.start").on("upload.start",function(){var i=q(this),l=i.attr("lay-data");if(l){try{l=new Function("return "+l)(),e.config=q.extend({},c,l)}catch(n){k.error("Upload element property lay-data configuration item has a syntax error: "+l)}}e.config.item=i,e.elemFile[0].click()}),y.ie&&y.ie<10||c.elem.off("upload.over").on("upload.over",function(){var i=q(this);i.attr("lay-over","")}).off("upload.leave").on("upload.leave",function(){var i=q(this);i.removeAttr("lay-over")}).off("upload.drop").on("upload.drop",function(i,l){var o=q(this),n=l.originalEvent.dataTransfer.files||[];o.removeAttr("lay-over"),f(n),c.auto?e.upload(n):a(n)}),e.elemFile.off("upload.change").on("upload.change",function(){var i=this.files||[];f(i),c.auto?e.upload():a(i)}),c.bindAction.off("upload.action").on("upload.action",function(){e.upload()}),c.elem.data("haveEvents")||(e.elemFile.on("change",function(){q(this).trigger("upload.change")}),c.elem.on("click",function(){e.isFile()||q(this).trigger("upload.start")}),c.drag&&c.elem.on("dragover",function(i){i.preventDefault(),q(this).trigger("upload.over")}).on("dragleave",function(i){q(this).trigger("upload.leave")}).on("drop",function(i){i.preventDefault(),q(this).trigger("upload.drop",i)}),c.bindAction.on("click",function(){q(this).trigger("upload.action")}),c.elem.data("haveEvents",!0))},j.render=function(c){var a=new h(c);return m.call(a)},w(b,j)});