layui.define(["layer","laytpl","upload"],function(aL){var ag="3.6.0 Pro",aG=layui.$,av=layui.layer,aB=layui.laytpl,aF=layui.device(),aw="layui-show",aA="layim-this",aI=20,ax={},aK=function(){this.v=ag,aG("body").on("click","*[layim-event]",function(b){var c=aG(this),a=c.attr("layim-event");aP[a]?aP[a].call(this,c,b):""})};aK.prototype.config=function(a){var b=[];if(layui.each(Array(5),function(c){b.push(layui.cache.dir+"css/modules/layim/skin/"+(c+1)+".jpg")}),a=a||{},a.skin=a.skin||[],layui.each(a.skin,function(c,d){b.unshift(d)}),a.skin=b,a=aG.extend({isfriend:!0,isgroup:!0,voice:"default.mp3"},a),window.JSON&&window.JSON.parse){return a9(a),this}},aK.prototype.on=function(a,b){return"function"==typeof b&&(ax[a]?ax[a].push(b):ax[a]=[b]),this},aK.prototype.cache=function(){return aJ},aK.prototype.chat=function(a){if(window.JSON&&window.JSON.parse){return ao(a),this}},aK.prototype.setChatMin=function(){return a2(),this},aK.prototype.setChatStatus=function(a){var c=ah();if(c){var b=c.elem.find(".layim-chat-status");return b.html(a),this}},aK.prototype.getMessage=function(a){return a5(a),this},aK.prototype.notice=function(a){return a6(a),this},aK.prototype.add=function(a){return a3(a),this},aK.prototype.setFriendGroup=function(a){return a3(a,"setGroup"),this},aK.prototype.msgbox=function(a){return aU(a),this},aK.prototype.addList=function(a){return aV(a),this},aK.prototype.removeList=function(a){return aT(a),this},aK.prototype.setFriendStatus=function(b,c){var a=aG(".layim-friend"+b);a["online"===c?"removeClass":"addClass"]("layim-list-gray")},aK.prototype.content=function(a){return layui.data.content(a)};var au=function(a){var b={friend:"该分组下暂无好友",group:"暂无群组",history:"暂无历史会话"};return a=a||{},a.item=a.item||"d."+a.type,["{{# var length = 0; layui.each("+a.item+", function(i, data){ length++; }}",'<li layim-event="chat" data-type="'+a.type+'" data-index="{{ '+(a.index||"i")+' }}" class="layim-'+("history"===a.type?"{{i}}":a.type+"{{data.id}}")+' {{ data.status === "offline" ? "layim-list-gray" : "" }}"><img src="{{ data.avatar }}"><span>{{ data.username||data.groupname||data.name||"佚名" }}</span><p>{{ data.remark||data.sign||"" }}</p><span class="layim-msg-status">new</span></li>',"{{# }); if(length === 0){ }}",'<li class="layim-null">'+(b[a.type]||"暂无数据")+"</li>","{{# } }}"].join("")},ap=['<div class="layui-layim-main">','<div class="layui-layim-info">','<div class="layui-layim-user">{{ d.mine.username }}</div>','<div class="layui-layim-status">','{{# if(d.mine.status === "online"){ }}','<span class="layui-icon layim-status-online" layim-event="status" lay-type="show">&#xe617;</span>','{{# } else if(d.mine.status === "hide") { }}','<span class="layui-icon layim-status-hide" layim-event="status" lay-type="show">&#xe60f;</span>',"{{# } }}",'<ul class="layui-anim layim-menu-box">','<li {{d.mine.status === "online" ? "class=layim-this" : ""}} layim-event="status" lay-type="online"><i class="layui-icon">&#xe618;</i><cite class="layui-icon layim-status-online">&#xe617;</cite>在线</li>','<li {{d.mine.status === "hide" ? "class=layim-this" : ""}} layim-event="status" lay-type="hide"><i class="layui-icon">&#xe618;</i><cite class="layui-icon layim-status-hide">&#xe60f;</cite>隐身</li>',"</ul>","</div>",'<input class="layui-layim-remark" placeholder="编辑签名" value="{{ d.mine.remark||d.mine.sign||"" }}">',"</div>",'<ul class="layui-unselect layui-layim-tab{{# if(!d.base.isfriend || !d.base.isgroup){ }}'," layim-tab-two",'{{# } }}">','<li class="layui-icon',"{{# if(!d.base.isfriend){ }}"," layim-hide","{{# } else { }}"," layim-this","{{# } }}",'" title="联系人" layim-event="tab" lay-type="friend">&#xe612;</li>','<li class="layui-icon',"{{# if(!d.base.isgroup){ }}"," layim-hide","{{# } else if(!d.base.isfriend) { }}"," layim-this","{{# } }}",'" title="群组" layim-event="tab" lay-type="group">&#xe613;</li>','<li class="layui-icon" title="历史会话" layim-event="tab" lay-type="history">&#xe611;</li>',"</ul>",'<ul class="layui-unselect layim-tab-content {{# if(d.base.isfriend){ }}layui-show{{# } }} layim-list-friend">','{{# layui.each(d.friend, function(index, item){ var spread = d.local["spread"+index]; }}',"<li>",'<h5 layim-event="spread" lay-type="{{ spread }}"><i class="layui-icon">{{# if(spread === "true"){ }}&#xe61a;{{# } else {  }}&#xe602;{{# } }}</i><span>{{ item.groupname||"未命名分组"+index }}</span><em>(<cite class="layim-count"> {{ (item.list||[]).length }}</cite>)</em></h5>','<ul class="layui-layim-list {{# if(spread === "true"){ }}'," layui-show",'{{# } }}">',au({type:"friend",item:"item.list",index:"index"}),"</ul>","</li>","{{# }); if(d.friend.length === 0){ }}",'<li><ul class="layui-layim-list layui-show"><li class="layim-null">暂无联系人</li></ul>',"{{# } }}","</ul>",'<ul class="layui-unselect layim-tab-content {{# if(!d.base.isfriend && d.base.isgroup){ }}layui-show{{# } }}">',"<li>",'<ul class="layui-layim-list layui-show layim-list-group">',au({type:"group"}),"</ul>","</li>","</ul>",'<ul class="layui-unselect layim-tab-content  {{# if(!d.base.isfriend && !d.base.isgroup){ }}layui-show{{# } }}">',"<li>",'<ul class="layui-layim-list layui-show layim-list-history">',au({type:"history"}),"</ul>","</li>","</ul>",'<ul class="layui-unselect layim-tab-content">',"<li>",'<ul class="layui-layim-list layui-show" id="layui-layim-search"></ul>',"</li>","</ul>",'<ul class="layui-unselect layui-layim-tool">','<li class="layui-icon layim-tool-search" layim-event="search" title="搜索">&#xe615;</li>',"{{# if(d.base.msgbox){ }}",'<li class="layui-icon layim-tool-msgbox" layim-event="msgbox" title="消息盒子">&#xe645;<span class="layui-anim"></span></li>',"{{# } }}","{{# if(d.base.find){ }}",'<li class="layui-icon layim-tool-find" layim-event="find" title="查找">&#xe608;</li>',"{{# } }}",'<li class="layui-icon layim-tool-skin" layim-event="skin" title="更换背景">&#xe61b;</li>',"{{# if(!d.base.copyright){ }}",'<li class="layui-icon layim-tool-about" layim-event="about" title="关于">&#xe60b;</li>',"{{# } }}","</ul>",'<div class="layui-layim-search"><input><label class="layui-icon" layim-event="closeSearch">&#x1007;</label></div>',"</div>"].join(""),aD=['<ul class="layui-layim-skin">',"{{# layui.each(d.skin, function(index, item){ }}",'<li><img layim-event="setSkin" src="{{ item }}"></li>',"{{# }); }}",'<li layim-event="setSkin"><cite>简约</cite></li>',"</ul>"].join(""),aC=['<div class="layim-chat layim-chat-{{d.data.type}}{{d.first ? " layui-show" : ""}}">','<div class="layui-unselect layim-chat-title">','<div class="layim-chat-other">','<img class="layim-{{ d.data.type }}{{ d.data.id }}" src="{{ d.data.avatar }}"><span class="layim-chat-username" layim-event="{{ d.data.type==="group" ? "groupMembers" : "" }}">{{ d.data.name||"佚名" }} {{d.data.temporary ? "<cite>临时会话</cite>" : ""}} {{# if(d.data.type==="group"){ }} <em class="layim-chat-members"></em><i class="layui-icon">&#xe61a;</i> {{# } }}</span>','<p class="layim-chat-status"></p>',"</div>","</div>",'<div class="layim-chat-main">',"<ul></ul>","</div>",'<div class="layim-chat-footer">','<div class="layui-unselect layim-chat-tool" data-json="{{encodeURIComponent(JSON.stringify(d.data))}}">','<span class="layui-icon layim-tool-face" title="选择表情" layim-event="face">&#xe60c;</span>',"{{# if(d.base && d.base.uploadImage){ }}",'<span class="layui-icon layim-tool-image" title="上传图片" layim-event="image">&#xe60d;<input type="file" name="file"></span>',"{{# }; }}","{{# if(d.base && d.base.uploadFile){ }}",'<span class="layui-icon layim-tool-image" title="发送文件" layim-event="image" data-type="file">&#xe61d;<input type="file" name="file"></span>',"{{# }; }}","{{# if(d.base && d.base.isAudio){ }}",'<span class="layui-icon layim-tool-audio" title="发送网络音频" layim-event="media" data-type="audio">&#xe6fc;</span>',"{{# }; }}","{{# if(d.base && d.base.isVideo){ }}",'<span class="layui-icon layim-tool-video" title="发送网络视频" layim-event="media" data-type="video">&#xe6ed;</span>',"{{# }; }}","{{# layui.each(d.base.tool, function(index, item){ }}",'<span class="layui-icon layim-tool-{{item.alias}}" title="{{item.title}}" layim-event="extend" lay-filter="{{ item.alias }}">{{item.icon}}</span>',"{{# }); }}","{{# if(d.base && d.base.chatLog){ }}",'<span class="layim-tool-log" layim-event="chatLog"><i class="layui-icon">&#xe60e;</i>聊天记录</span>',"{{# }; }}","</div>",'<div class="layim-chat-textarea"><textarea></textarea></div>','<div class="layim-chat-bottom">','<div class="layim-chat-send">',"{{# if(!d.base.brief){ }}",'<span class="layim-send-close" layim-event="closeThisChat">关闭</span>',"{{# } }}",'<span class="layim-send-btn" layim-event="send">发送</span>','<span class="layim-send-set" layim-event="setSend" lay-type="show"><em class="layui-edge"></em></span>','<ul class="layui-anim layim-menu-box">','<li {{d.local.sendHotKey !== "Ctrl+Enter" ? "class=layim-this" : ""}} layim-event="setSend" lay-type="Enter"><i class="layui-icon">&#xe618;</i>按Enter键发送消息</li>','<li {{d.local.sendHotKey === "Ctrl+Enter" ? "class=layim-this" : ""}} layim-event="setSend"  lay-type="Ctrl+Enter"><i class="layui-icon">&#xe618;</i>按Ctrl+Enter键发送消息</li>',"</ul>","</div>","</div>","</div>","</div>"].join(""),az=['<div class="layim-add-box">','<div class="layim-add-img"><img class="layui-circle" src="{{ d.data.avatar }}"><p>{{ d.data.name||"" }}</p></div>','<div class="layim-add-remark">','{{# if(d.data.type === "friend" && d.type === "setGroup"){ }}',"<p>选择分组</p>",'{{# } if(d.data.type === "friend"){ }}','<select class="layui-select" id="LAY_layimGroup">',"{{# layui.each(d.data.group, function(index, item){ }}",'<option value="{{ item.id }}">{{ item.groupname }}</option>',"{{# }); }}","</select>","{{# } }}",'{{# if(d.data.type === "group"){ }}',"<p>请输入验证信息</p>",'{{# } if(d.type !== "setGroup"){ }}','<textarea id="LAY_layimRemark" placeholder="验证信息" class="layui-textarea"></textarea>',"{{# } }}","</div>","</div>"].join(""),aN=['<li {{ d.mine ? "class=layim-chat-mine" : "" }} {{# if(d.cid){ }}data-cid="{{d.cid}}"{{# } }}>','<div class="layim-chat-user"><img src="{{ d.avatar }}"><cite>',"{{# if(d.mine){ }}",'<i>{{ layui.data.date(d.timestamp) }}</i>{{ d.username||"佚名" }}',"{{# } else { }}",'{{ d.username||"佚名" }}<i>{{ layui.data.date(d.timestamp) }}</i>',"{{# } }}","</cite></div>",'<div class="layim-chat-text">{{ layui.data.content(d.content||"&nbsp") }}</div>',"</li>"].join(""),at='<li class="layim-{{ d.data.type }}{{ d.data.id }} layim-chatlist-{{ d.data.type }}{{ d.data.id }} layim-this" layim-event="tabChat"><img src="{{ d.data.avatar }}"><span>{{ d.data.name||"佚名" }}</span>{{# if(!d.base.brief){ }}<i class="layui-icon" layim-event="closeChat">&#x1007;</i>{{# } }}</li>',aO=function(a){return a<10?"0"+(0|a):a};layui.data.date=function(a){var b=new Date(a||new Date);return b.getFullYear()+"-"+aO(b.getMonth()+1)+"-"+aO(b.getDate())+" "+aO(b.getHours())+":"+aO(b.getMinutes())+":"+aO(b.getSeconds())},layui.data.content=function(a){var b=function(c){return new RegExp("\\n*\\["+(c||"")+"(code|pre|div|span|p|table|thead|th|tbody|tr|td|ul|li|ol|li|dl|dt|dd|h2|h3|h4|h5)([\\s\\S]*?)\\]\\n*","g")};return a=(a||"").replace(/&(?!#?[a-zA-Z0-9]+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#39;").replace(/"/g,"&quot;").replace(/@(\S+)(\s+?|$)/g,'@<a href="javascript:;">$1</a>$2').replace(/face\[([^\s\[\]]+?)\]/g,function(c){var d=c.replace(/^face/g,"");return'<img alt="'+d+'" title="'+d+'" src="'+aS[d]+'">'}).replace(/img\[([^\s]+?)\]/g,function(c){return'<img class="layui-layim-photos" src="'+c.replace(/(^img\[)|(\]$)/g,"")+'">'}).replace(/file\([\s\S]+?\)\[[\s\S]*?\]/g,function(e){var d=(e.match(/file\(([\s\S]+?)\)\[/)||[])[1],c=(e.match(/\)\[([\s\S]*?)\]/)||[])[1];return d?'<a class="layui-layim-file" href="'+d+'" download target="_blank"><i class="layui-icon">&#xe61e;</i><cite>'+(c||d)+"</cite></a>":e}).replace(/audio\[([^\s]+?)\]/g,function(c){return'<div class="layui-unselect layui-layim-audio" layim-event="playAudio" data-src="'+c.replace(/(^audio\[)|(\]$)/g,"")+'"><i class="layui-icon">&#xe652;</i><p>音频消息</p></div>'}).replace(/video\[([^\s]+?)\]/g,function(c){return'<div class="layui-unselect layui-layim-video" layim-event="playVideo" data-src="'+c.replace(/(^video\[)|(\]$)/g,"")+'"><i class="layui-icon">&#xe652;</i></div>'}).replace(/a\([\s\S]+?\)\[[\s\S]*?\]/g,function(e){var d=(e.match(/a\(([\s\S]+?)\)\[/)||[])[1],c=(e.match(/\)\[([\s\S]*?)\]/)||[])[1];return d?'<a href="'+d+'" target="_blank">'+(c||d)+"</a>":e}).replace(b(),"<$1 $2>").replace(b("/"),"</$1>").replace(/\n/g,"<br>")};var aq,aM,ar,aH,aj,aX=function(a,c,b){return a=a||{},aG.ajax({url:a.url,type:a.type||"get",data:a.data,dataType:a.dataType||"json",cache:!1,success:function(d){0==d.code?c&&c(d.data||{}):av.msg(d.msg||(b||"Error")+": LAYIM_NOT_GET_DATA",{time:5000})},error:function(e,d){window.console&&console.log&&console.error("LAYIM_DATE_ERROR："+d)}})},aJ={message:{},chat:[]},a9=function(a){var b=a.init||{};return mine=b.mine||{},local=layui.data("layim")[mine.id]||{},obj={base:a,local:local,mine:mine,history:local.history||{}},create=function(e){var f=e.mine||{},d=layui.data("layim")[f.id]||{},c={base:a,local:d,mine:f,friend:e.friend||[],group:e.group||[],history:d.history||{}};aJ=aG.extend(aJ,c),a4(aB(ap).render(c)),(d.close||a.min)&&aW(),layui.each(ax.ready,function(h,g){g&&g(c)})},aJ=aG.extend(aJ,obj),a.brief?layui.each(ax.ready,function(c,d){d&&d(obj)}):void (b.url?aX(b,create,"INIT"):create(b))},a4=function(a){return av.open({type:1,area:["260px","520px"],skin:"layui-box layui-layim",title:"&#8203;",offset:"rb",id:"layui-layim",shade:!1,anim:2,resize:!1,content:a,success:function(d){aq=d,aY(d),aJ.base.right&&d.css("margin-left","-"+aJ.base.right),aM&&av.close(aM.attr("times"));var c=[],b=d.find(".layim-list-history");b.find("li").each(function(){c.push(aG(this).prop("outerHTML"))}),c.length>0&&(c.reverse(),b.html(c.join(""))),al(),aP.sign()},cancel:function(b){aW();var c=layui.data("layim")[aJ.mine.id]||{};return c.close=!0,layui.data("layim",{key:aJ.mine.id,value:c}),!1}})},al=function(){aq.on("contextmenu",function(b){return b.cancelBubble=!0,b.returnValue=!1,!1});var a=function(){av.closeAll("tips")};aq.find(".layim-list-history").on("contextmenu","li",function(d){var b=aG(this),c='<ul data-id="'+b[0].id+'" data-index="'+b.data("index")+'"><li layim-event="menuHistory" data-type="one">移除该会话</li><li layim-event="menuHistory" data-type="all">清空全部会话列表</li></ul>';b.hasClass("layim-null")||(av.tips(c,this,{tips:1,time:0,anim:5,fixed:!0,skin:"layui-box layui-layim-contextmenu",success:function(f){var e=function(g){an(g)};f.off("mousedown",e).on("mousedown",e)}}),aG(document).off("mousedown",a).on("mousedown",a),aG(window).off("resize",a).on("resize",a))})},aW=function(a){return aM&&av.close(aM.attr("times")),aq&&aq.hide(),aJ.mine=aJ.mine||{},av.open({type:1,title:!1,id:"layui-layim-close",skin:"layui-box layui-layim-min layui-layim-close",shade:!1,closeBtn:!1,anim:2,offset:"rb",resize:!1,content:'<img src="'+(aJ.mine.avatar||layui.cache.dir+"css/pc/layim/skin/logo.jpg")+'"><span>'+(a||aJ.base.title||"我的LayIM")+"</span>",move:"#layui-layim-close img",success:function(b,c){aM=b,aJ.base.right&&b.css("margin-left","-"+aJ.base.right),b.on("click",function(){av.close(c),aq.show();var d=layui.data("layim")[aJ.mine.id]||{};delete d.close,layui.data("layim",{key:aJ.mine.id,value:d})})}})},ao=function(f){f=f||{};var d=aG("#layui-layim-chat"),b={data:f,base:aJ.base,local:aJ.local};if(!f.id){return av.msg("非法用户")}if(d[0]){var g=ar.find(".layim-chat-list"),a=g.find(".layim-chatlist-"+f.type+f.id),h=ar.find(".layui-layer-max").hasClass("layui-layer-maxmin"),c=d.children(".layim-chat-box");return"none"===ar.css("display")&&ar.show(),aH&&av.close(aH.attr("times")),1!==g.find("li").length||a[0]||(h||ar.css("width",800),g.css({height:ar.height()}).show(),c.css("margin-left","200px")),a[0]||(g.append(aB(at).render(b)),c.append(aB(aC).render(b)),a7(f),bc()),a1(g.find(".layim-chatlist-"+f.type+f.id)),a[0]||a0(),am(f),aZ(),aj}b.first=!0;var e=aj=av.open({type:1,area:"600px",skin:"layui-box layui-layim-chat",id:"layui-layim-chat",title:"&#8203;",shade:!1,maxmin:!0,offset:f.offset||"auto",anim:f.anim||0,closeBtn:!aJ.base.brief&&1,content:aB('<ul class="layui-unselect layim-chat-list">'+at+'</ul><div class="layim-chat-box">'+aC+"</div>").render(b),success:function(i){ar=i,i.css({"min-width":"500px","min-height":"420px"}),a7(f),"function"==typeof f.success&&f.success(i),aZ(),aY(i),am(f),a0(),ay(),layui.each(ax.chatChange,function(k,j){j&&j(ah())}),i.on("dblclick",".layui-layim-photos",function(){var j=this.src;av.close(ao.photosIndex),av.photos({photos:{data:[{alt:"大图模式",src:j}]},shade:0.01,closeBtn:2,anim:0,resize:!1,success:function(l,k){ao.photosIndex=k}})})},full:function(i){av.style(e,{width:"100%",height:"100%"},!0),bc()},resizing:bc,restore:bc,min:function(){return a2(),!1},end:function(){av.closeAll("tips"),ar=null}});return e},a7=function(a){aG(".layim-"+a.type+a.id).each(function(){aG(this).hasClass("layim-list-gray")&&layui.layim.setFriendStatus(a.id,"offline")})},bc=function(){var a=ar.find(".layim-chat-list"),c=ar.find(".layim-chat-main"),b=ar.height();a.css({height:b}),c.css({height:b-20-80-158})},a2=function(a){var c=a||ah().data,b=layui.layim.cache().base;ar&&!a&&ar.hide(),av.close(a2.index),a2.index=av.open({type:1,title:!1,skin:"layui-box layui-layim-min",shade:!1,closeBtn:!1,anim:c.anim||2,offset:"b",move:"#layui-layim-min",resize:!1,area:["182px","50px"],content:'<img id="layui-layim-min" src="'+c.avatar+'"><span>'+c.name+"</span>",success:function(e,d){a||(aH=e),b.minRight&&av.style(d,{left:aG(window).width()-e.outerWidth()-parseFloat(b.minRight)}),e.find(".layui-layer-content span").on("click",function(){av.close(d),a?layui.each(aJ.chat,function(g,f){ao(f)}):ar.show(),a&&(aJ.chat=[],aQ())}),e.find(".layui-layer-content img").on("click",function(f){an(f)})}})},a3=function(a,b){return a=a||{},av.close(a3.index),a3.index=av.open({type:1,area:"430px",title:{friend:"添加好友",group:"加入群组"}[a.type]||"",shade:!1,resize:!1,btn:b?["确认","取消"]:["发送申请","关闭"],content:aB(az).render({data:{name:a.username||a.groupname,avatar:a.avatar,group:a.group||parent.layui.layim.cache().friend||[],type:a.type},type:b}),yes:function(e,d){var f=d.find("#LAY_layimGroup"),c=d.find("#LAY_layimRemark");b?a.submit&&a.submit(f.val(),e):a.submit&&a.submit(f.val(),c.val(),e)}})},a1=function(f,d){f=f||aG(".layim-chat-list ."+aA);var b=f.index()===-1?0:f.index(),c=".layim-chat",g=ar.find(c).eq(b),a=ar.find(".layui-layer-max").hasClass("layui-layer-maxmin");if(d){f.hasClass(aA)&&a1(0===b?f.next():f.prev());var e=ar.find(c).length;return 1===e?av.close(aj):(f.remove(),g.remove(),2===e&&(ar.find(".layim-chat-list").hide(),a||ar.css("width","600px"),ar.find(".layim-chat-box").css("margin-left",0)),!1)}f.addClass(aA).siblings().removeClass(aA),g.addClass(aw).siblings(c).removeClass(aw),g.find("textarea").focus(),layui.each(ax.chatChange,function(i,h){h&&h(ah())}),ay()},ay=function(){var a=ah(),b=aJ.message[a.data.type+a.data.id];b&&delete aJ.message[a.data.type+a.data.id]},ah=function(){if(ar){var b=aG(".layim-chat-list ."+aA).index(),c=ar.find(".layim-chat").eq(b),a=JSON.parse(decodeURIComponent(c.find(".layim-chat-tool").data("json")));return{elem:c,data:a,textarea:c.find("textarea")}}},aY=function(a){var c=layui.data("layim")[aJ.mine.id]||{},b=c.skin;a.css({"background-image":b?"url("+b+")":function(){return aJ.base.initSkin?"url("+(layui.cache.dir+"css/modules/layim/skin/"+aJ.base.initSkin)+")":"none"}()})},am=function(f){var d=layui.data("layim")[aJ.mine.id]||{},a={},e=d.history||{},c=e[f.type+f.id];if(aq){var g=aq.find(".layim-list-history");if(f.historyTime=(new Date).getTime(),e[f.type+f.id]=f,d.history=e,layui.data("layim",{key:aJ.mine.id,value:d}),!c){a[f.type+f.id]=f;var b=aB(au({type:"history",item:"d.data"})).render({data:a});g.prepend(b),g.find(".layim-null").remove()}}},ai=function(){var e={username:aJ.mine?aJ.mine.username:"访客",avatar:aJ.mine?aJ.mine.avatar:layui.cache.dir+"css/pc/layim/skin/logo.jpg",id:aJ.mine?aJ.mine.id:null,mine:!0},d=ah(),a=d.elem.find(".layim-chat-main ul"),c=aJ.base.maxLength||3000;if(e.content=d.textarea.val(),""!==e.content.replace(/\s/g,"")){if(e.content.length>c){return av.msg("内容最长不能超过"+c+"个字符")}a.append(aB(aN).render(e));var f={mine:e,to:d.data},b={username:f.mine.username,avatar:f.mine.avatar,id:f.to.id,type:f.to.type,content:f.mine.content,timestamp:(new Date).getTime(),mine:!0};ak(b),layui.each(ax.sendMessage,function(h,g){g&&g(f)})}aQ(),d.textarea.val("").focus()},a6=function(a){if(a=a||{},window.Notification){if("granted"===Notification.permission){new Notification(a.title||"",{body:a.content||"",icon:a.avatar||"http://tp2.sinaimg.cn/5488749285/50/5719808192/1"})}else{Notification.requestPermission()}}},bb=function(){if(!(aF.ie&&aF.ie<9)){var a=document.createElement("audio");a.src=layui.cache.dir+"css/modules/layim/voice/"+aJ.base.voice,a.play()}},ba={},a5=function(d){d=d||{};var g=aG(".layim-chatlist-"+d.type+d.id),h={},c=g.index();if(d.timestamp=d.timestamp||(new Date).getTime(),d.fromid==aJ.mine.id&&(d.mine=!0),d.system||ak(d),ba=JSON.parse(JSON.stringify(d)),aJ.base.voice&&bb(),!ar&&d.content||c===-1){if(aJ.message[d.type+d.id]){aJ.message[d.type+d.id].push(d)}else{if(aJ.message[d.type+d.id]=[d],"friend"===d.type){var i;layui.each(aJ.friend,function(j,k){if(layui.each(k.list,function(l,m){if(m.id==d.id){return m.type="friend",m.name=m.username,aJ.chat.push(m),i=!0}}),i){return !0}}),i||(d.name=d.username,d.temporary=!0,aJ.chat.push(d))}else{if("group"===d.type){var b;layui.each(aJ.group,function(j,k){if(k.id==d.id){return k.type="group",k.name=k.groupname,aJ.chat.push(k),b=!0}}),b||(d.name=d.groupname,aJ.chat.push(d))}else{d.name=d.name||d.username||d.groupname,aJ.chat.push(d)}}}if("group"===d.type&&layui.each(aJ.group,function(j,k){if(k.id==d.id){return h.avatar=k.avatar,!0}}),!d.system){return aJ.base.notice&&a6({title:"来自 "+d.username+" 的消息",content:d.content,avatar:h.avatar||d.avatar}),a2({name:"收到新消息",avatar:h.avatar||d.avatar,anim:6})}}if(ar){var e=ah();e.data.type+e.data.id!==d.type+d.id&&(g.addClass("layui-anim layer-anim-06"),setTimeout(function(){g.removeClass("layui-anim layer-anim-06")},300));var a=ar.find(".layim-chat").eq(c),f=a.find(".layim-chat-main ul");d.system?c!==-1&&f.append('<li class="layim-chat-system"><span>'+d.content+"</span></li>"):""!==d.content.replace(/\s/g,"")&&f.append(aB(aN).render(d)),aQ()}},aR="layui-anim-loop layer-anim-05",aU=function(a){var b=aq.find(".layim-tool-msgbox");b.find("span").addClass(aR).html(a)},ak=function(a){var c=layui.data("layim")[aJ.mine.id]||{};c.chatlog=c.chatlog||{};var b=c.chatlog[a.type+a.id];if(b){var d;layui.each(b,function(e,f){f.timestamp===a.timestamp&&f.type===a.type&&f.id===a.id&&f.content===a.content&&(d=!0)}),d||a.fromid==aJ.mine.id||b.push(a),b.length>aI&&b.shift()}else{c.chatlog[a.type+a.id]=[a]}layui.data("layim",{key:aJ.mine.id,value:c})},a0=function(){var a=layui.data("layim")[aJ.mine.id]||{},c=ah(),b=a.chatlog||{},d=c.elem.find(".layim-chat-main ul");layui.each(b[c.data.type+c.data.id],function(f,e){d.append(aB(aN).render(e))}),aQ()},aV=function(e){var d,a={},c=aq.find(".layim-list-"+e.type);if(aJ[e.type]){if("friend"===e.type){layui.each(aJ.friend,function(g,h){if(e.groupid==h.id){return layui.each(aJ.friend[g].list,function(j,i){if(i.id==e.id){return d=!0}}),d?av.msg("好友 ["+(e.username||"")+"] 已经存在列表中",{anim:6}):(aJ.friend[g].list=aJ.friend[g].list||[],a[aJ.friend[g].list.length]=e,e.groupIndex=g,aJ.friend[g].list.push(e),!0)}})}else{if("group"===e.type){if(layui.each(aJ.group,function(g,h){if(h.id==e.id){return d=!0}}),d){return av.msg("您已是 ["+(e.groupname||"")+"] 的群成员",{anim:6})}a[aJ.group.length]=e,aJ.group.push(e)}}}if(!d){var f=aB(au({type:e.type,item:"d.data",index:"friend"===e.type?"data.groupIndex":null})).render({data:a});if("friend"===e.type){var b=c.find(">li").eq(e.groupIndex);b.find(".layui-layim-list").append(f),b.find(".layim-count").html(aJ.friend[e.groupIndex].list.length),b.find(".layim-null")[0]&&b.find(".layim-null").remove()}else{"group"===e.type&&(c.append(f),c.find(".layim-null")[0]&&c.find(".layim-null").remove())}}},aT=function(a){var b=aq.find(".layim-list-"+a.type);aJ[a.type]&&("friend"===a.type?layui.each(aJ.friend,function(d,c){layui.each(c.list,function(f,g){if(a.id==g.id){var e=b.find(">li").eq(d);e.find(".layui-layim-list>li");return e.find(".layui-layim-list>li").eq(f).remove(),aJ.friend[d].list.splice(f,1),e.find(".layim-count").html(aJ.friend[d].list.length),0===aJ.friend[d].list.length&&e.find(".layui-layim-list").html('<li class="layim-null">该分组下已无好友了</li>'),!0}})}):"group"===a.type&&layui.each(aJ.group,function(d,c){if(a.id==c.id){return b.find(">li").eq(d).remove(),aJ.group.splice(d,1),0===aJ.group.length&&b.html('<li class="layim-null">暂无群组</li>'),!0}}))},aQ=function(){var e=ah(),c=e.elem.find(".layim-chat-main"),a=c.find("ul"),d=a.find("li").length;if(d>=aI){var b=a.find("li").eq(0);a.prev().hasClass("layim-chat-system")||a.before('<div class="layim-chat-system"><span layim-event="chatLog">查看更多记录</span></div>'),d>aI&&b.remove()}c.scrollTop(c[0].scrollHeight+1000),c.find("ul li:last").find("img").load(function(){c.scrollTop(c[0].scrollHeight+1000)})},aZ=function(){var a=ah(),b=a.textarea;b.focus(),b.off("keydown").on("keydown",function(d){var e=layui.data("layim")[aJ.mine.id]||{},c=d.keyCode;if("Ctrl+Enter"===e.sendHotKey){return void (d.ctrlKey&&13===c&&ai())}if(13===c){if(d.ctrlKey){return b.val(b.val()+"\n")}if(d.shiftKey){return}d.preventDefault(),ai()}})},aS=function(){var a=["[微笑]","[嘻嘻]","[哈哈]","[可爱]","[可怜]","[挖鼻]","[吃惊]","[害羞]","[挤眼]","[闭嘴]","[鄙视]","[爱你]","[泪]","[偷笑]","[亲亲]","[生病]","[太开心]","[白眼]","[右哼哼]","[左哼哼]","[嘘]","[衰]","[委屈]","[吐]","[哈欠]","[抱抱]","[怒]","[疑问]","[馋嘴]","[拜拜]","[思考]","[汗]","[困]","[睡]","[钱]","[失望]","[酷]","[色]","[哼]","[鼓掌]","[晕]","[悲伤]","[抓狂]","[黑线]","[阴险]","[怒骂]","[互粉]","[心]","[伤心]","[猪头]","[熊猫]","[兔子]","[ok]","[耶]","[good]","[NO]","[赞]","[来]","[弱]","[草泥马]","[神马]","[囧]","[浮云]","[给力]","[围观]","[威武]","[奥特曼]","[礼物]","[钟]","[话筒]","[蜡烛]","[蛋糕]"],b={};return layui.each(a,function(c,d){b[d]=layui.cache.dir+"images/face/"+c+".gif"}),b}(),an=layui.stope,a8=function(a,c){var b,d=a.value;a.focus(),document.selection?(b=document.selection.createRange(),document.selection.empty(),b.text=c):(b=[d.substring(0,a.selectionStart),c,d.substr(a.selectionEnd)],a.focus(),a.value=b.join(""))},aE="layui-anim-upbit",aP={status:function(a,d){var e=function(){a.next().hide().removeClass(aE)},b=a.attr("lay-type");if("show"===b){an(d),a.next().show().addClass(aE),aG(document).off("click",e).on("click",e)}else{var c=a.parent().prev();a.addClass(aA).siblings().removeClass(aA),c.html(a.find("cite").html()),c.removeClass("layim-status-"+("online"===b?"hide":"online")).addClass("layim-status-"+b),layui.each(ax.online,function(g,f){f&&f(b)})}},sign:function(){var a=aq.find(".layui-layim-remark");a.on("change",function(){var b=this.value;layui.each(ax.sign,function(d,c){c&&c(b)})}),a.on("keyup",function(b){var c=b.keyCode;13===c&&this.blur()})},tab:function(a){var c,b=".layim-tab-content",d=aq.find(".layui-layim-tab>li");"number"==typeof a?(c=a,a=d.eq(c)):c=a.index(),c>2?d.removeClass(aA):(aP.tab.index=c,a.addClass(aA).siblings().removeClass(aA)),aq.find(b).eq(c).addClass(aw).siblings(b).removeClass(aw)},spread:function(a){var c=a.attr("lay-type"),b="true"===c?"false":"true",d=layui.data("layim")[aJ.mine.id]||{};a.next()["true"===c?"removeClass":"addClass"](aw),d["spread"+a.parent().index()]=b,layui.data("layim",{key:aJ.mine.id,value:d}),a.attr("lay-type",b),a.find(".layui-icon").html("true"===b?"&#xe61a;":"&#xe602;")},search:function(e){var c=aq.find(".layui-layim-search"),a=aq.find("#layui-layim-search"),d=c.find("input"),b=function(m){var f=d.val().replace(/\s/);if(""===f){aP.tab(0|aP.tab.index)}else{for(var k=[],l=aJ.friend||[],h=aJ.group||[],j="",n=0;n<l.length;n++){for(var i=0;i<(l[n].list||[]).length;i++){l[n].list[i].username.indexOf(f)!==-1&&(l[n].list[i].type="friend",l[n].list[i].index=n,l[n].list[i].list=i,k.push(l[n].list[i]))}}for(var o=0;o<h.length;o++){h[o].groupname.indexOf(f)!==-1&&(h[o].type="group",h[o].index=o,h[o].list=o,k.push(h[o]))}if(k.length>0){for(var g=0;g<k.length;g++){j+='<li layim-event="chat" data-type="'+k[g].type+'" data-index="'+k[g].index+'" data-list="'+k[g].list+'"><img src="'+k[g].avatar+'"><span>'+(k[g].username||k[g].groupname||"佚名")+"</span><p>"+(k[g].remark||k[g].sign||"")+"</p></li>"}}else{j='<li class="layim-null">无搜索结果</li>'}a.html(j),aP.tab(3)}};!aJ.base.isfriend&&aJ.base.isgroup?aP.tab.index=1:aJ.base.isfriend||aJ.base.isgroup||(aP.tab.index=2),c.show(),d.focus(),d.off("keyup",b).on("keyup",b)},closeSearch:function(a){a.parent().hide(),aP.tab(0|aP.tab.index)},msgbox:function(){var a=aq.find(".layim-tool-msgbox");return av.close(aP.msgbox.index),a.find("span").removeClass(aR).html(""),aP.msgbox.index=av.open({type:2,title:"消息盒子",shade:!1,maxmin:!0,area:["600px","520px"],skin:"layui-box layui-layer-border",resize:!1,content:aJ.base.msgbox})},find:function(){return av.close(aP.find.index),aP.find.index=av.open({type:2,title:"查找",shade:!1,maxmin:!0,area:["1000px","520px"],skin:"layui-box layui-layer-border",resize:!1,content:aJ.base.find})},skin:function(){av.open({type:1,title:"更换背景",shade:!1,area:"300px",skin:"layui-box layui-layer-border",id:"layui-layim-skin",zIndex:66666666,resize:!1,content:aB(aD).render({skin:aJ.base.skin})})},about:function(){av.alert("版本： "+ag+'<br>版权所有：<a href="http://layim.layui.com" target="_blank">layim.layui.com</a>',{title:"关于 LayIM",shade:!1})},setSkin:function(a){var c=a.attr("src"),b=layui.data("layim")[aJ.mine.id]||{};b.skin=c,c||delete b.skin,layui.data("layim",{key:aJ.mine.id,value:b});try{aq.css({"background-image":c?"url("+c+")":"none"}),ar.css({"background-image":c?"url("+c+")":"none"})}catch(d){}layui.each(ax.setSkin,function(e,f){var g=(c||"").replace(layui.cache.dir+"css/modules/layim/skin/","");f&&f(g,c)})},chat:function(f){var d=layui.data("layim")[aJ.mine.id]||{},a=f.data("type"),e=f.data("index"),b=f.attr("data-list")||f.index(),c={};"friend"===a?c=aJ[a][e].list[b]:"group"===a?c=aJ[a][b]:"history"===a&&(c=(d.history||{})[e]||{}),c.name=c.name||c.username||c.groupname,"history"!==a&&(c.type=a),ao(c)},tabChat:function(a){a1(a)},closeChat:function(a,b){a1(a.parent(),1),an(b)},closeThisChat:function(){a1(null,1)},groupMembers:function(e,d){var b=e.find(".layui-icon"),c=function(){b.html("&#xe61a;"),e.data("down",null),av.close(aP.groupMembers.index)},a=function(f){an(f)};e.data("down")?c():(b.html("&#xe619;"),e.data("down",!0),aP.groupMembers.index=av.tips('<ul class="layim-members-list"></ul>',e,{tips:3,time:0,anim:5,fixed:!0,skin:"layui-box layui-layim-members",success:function(g){var i=aJ.base.members||{},f=ah(),j=g.find(".layim-members-list"),l="",k={},m=ar.find(".layui-layer-max").hasClass("layui-layer-maxmin"),h="none"===ar.find(".layim-chat-list").css("display");m&&j.css({width:aG(window).width()-22-(h||200)}),i.data=aG.extend(i.data,{id:f.data.id}),aX(i,function(n){layui.each(n.list,function(p,o){l+='<li data-uid="'+o.id+'"><a href="javascript:;"><img src="'+o.avatar+'"><cite>'+o.username+"</cite></a></li>",k[o.id]=o}),j.html(l),e.find(".layim-chat-members").html(n.members||(n.list||[]).length+"人"),j.find("li").on("click",function(){var p=aG(this).data("uid"),o=k[p];ao({name:o.username,type:"friend",avatar:o.avatar,id:o.id}),c()}),layui.each(ax.members,function(p,o){o&&o(n)})}),g.on("mousedown",function(n){an(n)})}}),aG(document).off("mousedown",c).on("mousedown",c),aG(window).off("resize",c).on("resize",c),e.off("mousedown",a).on("mousedown",a))},send:function(){ai()},setSend:function(a,d){var e=aP.setSend.box=a.siblings(".layim-menu-box"),b=a.attr("lay-type");if("show"===b){an(d),e.show().addClass(aE),aG(document).off("click",aP.setSendHide).on("click",aP.setSendHide)}else{a.addClass(aA).siblings().removeClass(aA);var c=layui.data("layim")[aJ.mine.id]||{};c.sendHotKey=b,layui.data("layim",{key:aJ.mine.id,value:c}),aP.setSendHide(d,a.parent())}},setSendHide:function(a,b){(b||aP.setSend.box).hide().removeClass(aE)},face:function(e,d){var b="",c=ah();for(var a in aS){b+='<li title="'+a+'"><img src="'+aS[a]+'"></li>'}b='<ul class="layui-clear layim-face-list">'+b+"</ul>",aP.face.index=av.tips(b,e,{tips:1,time:0,fixed:!0,skin:"layui-box layui-layim-face",success:function(f){f.find(".layim-face-list>li").on("mousedown",function(g){an(g)}).on("click",function(){a8(c.textarea[0],"face"+this.title+" "),av.close(aP.face.index)})}}),aG(document).off("mousedown",aP.faceHide).on("mousedown",aP.faceHide),aG(window).off("resize",aP.faceHide).on("resize",aP.faceHide),an(d)},faceHide:function(){av.close(aP.face.index)},image:function(e){var d=e.data("type")||"images",a={images:"uploadImage",file:"uploadFile"},b=ah(),c=aJ.base[a[d]]||{};layui.upload.render({url:c.url||"",method:c.type,elem:e.find("input")[0],type:d,done:function(f){0==f.code?(f.data=f.data||{},"images"===d?a8(b.textarea[0],"img["+(f.data.src||"")+"]"):"file"===d&&a8(b.textarea[0],"file("+(f.data.src||"")+")["+(f.data.name||"下载文件")+"]"),ai()):av.msg(f.msg||"上传失败")}})},media:function(a){var d=a.data("type"),b={audio:"音频",video:"视频"},c=ah();av.prompt({title:"请输入网络"+b[d]+"地址",shade:!1,offset:[a.offset().top-aG(window).scrollTop()-158+"px",a.offset().left+"px"]},function(f,e){a8(c.textarea[0],d+"["+f+"]"),ai(),av.close(e)})},extend:function(a){var c=a.attr("lay-filter"),b=ah();layui.each(ax["tool("+c+")"],function(d,e){e&&e.call(a,function(f){a8(b.textarea[0],f)},ai,b)})},playAudio:function(d){var c=d.data("audio"),a=c||document.createElement("audio"),b=function(){a.pause(),d.removeAttr("status"),d.find("i").html("&#xe652;")};return d.data("error")?av.msg("播放音频源异常"):a.play?void (d.attr("status")?b():(c||(a.src=d.data("src")),a.play(),d.attr("status","pause"),d.data("audio",a),d.find("i").html("&#xe651;"),a.onended=function(){b()},a.onerror=function(){av.msg("播放音频源异常"),d.data("error",!0),b()})):av.msg("您的浏览器不支持audio")},playVideo:function(a){var c=a.data("src"),b=document.createElement("video");return b.play?(av.close(aP.playVideo.index),void (aP.playVideo.index=av.open({type:1,title:"播放视频",area:["460px","300px"],maxmin:!0,shade:!1,content:'<div style="background-color: #000; height: 100%;"><video style="position: absolute; width: 100%; height: 100%;" src="'+c+'" loop="loop" autoplay="autoplay"></video></div>'}))):av.msg("您的浏览器不支持video")},chatLog:function(a){var b=ah();return aJ.base.chatLog?(av.close(aP.chatLog.index),aP.chatLog.index=av.open({type:2,maxmin:!0,title:"与 "+b.data.name+" 的聊天记录",area:["450px","100%"],shade:!1,offset:"rb",skin:"layui-box",anim:2,id:"layui-layim-chatlog",content:aJ.base.chatLog+"?id="+b.data.id+"&type="+b.data.type})):av.msg("未开启更多聊天记录")},menuHistory:function(e,d){var b=layui.data("layim")[aJ.mine.id]||{},c=e.parent(),f=e.data("type"),a=aq.find(".layim-list-history"),h='<li class="layim-null">暂无历史会话</li>';if("one"===f){var g=b.history;delete g[c.data("index")],b.history=g,layui.data("layim",{key:aJ.mine.id,value:b}),aG("#"+c.data("id")).remove(),0===a.find("li").length&&a.html(h)}else{"all"===f&&(delete b.history,layui.data("layim",{key:aJ.mine.id,value:b}),a.html(h))}av.closeAll("tips")}};aL("layim",new aK)}).addcss("modules/layim/layim.css?v=3.60Pro","skinlayimcss");