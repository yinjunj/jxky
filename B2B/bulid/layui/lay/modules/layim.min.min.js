layui.define(["layer","laytpl","upload"],function(A){var Z="3.6.0 Pro",ad=layui.$,L=layui.layer,F=layui.laytpl,D=layui.device(),K="layui-show",G="layim-this",ac=20,J={},ab=function(){this.v=Z,ad("body").on("click","*[layim-event]",function(ah){var ag=ad(this),ai=ag.attr("layim-event");x[ai]?x[ai].call(this,ag,ah):""})};ab.prototype.config=function(ah){var ag=[];if(layui.each(Array(5),function(ai){ag.push(layui.cache.dir+"css/modules/layim/skin/"+(ai+1)+".jpg")}),ah=ah||{},ah.skin=ah.skin||[],layui.each(ah.skin,function(ai,aj){ag.unshift(aj)}),ah.skin=ag,ah=ad.extend({isfriend:!0,isgroup:!0,voice:"default.mp3"},ah),window.JSON&&window.JSON.parse){return d(ah),this}},ab.prototype.on=function(ah,ag){return"function"==typeof ag&&(J[ah]?J[ah].push(ag):J[ah]=[ag]),this},ab.prototype.cache=function(){return B},ab.prototype.chat=function(ag){if(window.JSON&&window.JSON.parse){return R(ag),this}},ab.prototype.setChatMin=function(){return k(),this},ab.prototype.setChatStatus=function(ai){var ag=Y();if(ag){var ah=ag.elem.find(".layim-chat-status");return ah.html(ai),this}},ab.prototype.getMessage=function(ag){return h(ag),this},ab.prototype.notice=function(ag){return g(ag),this},ab.prototype.add=function(ag){return j(ag),this},ab.prototype.setFriendGroup=function(ag){return j(ag,"setGroup"),this},ab.prototype.msgbox=function(ag){return s(ag),this},ab.prototype.addList=function(ag){return r(ag),this},ab.prototype.removeList=function(ag){return t(ag),this},ab.prototype.setFriendStatus=function(ah,ag){var ai=ad(".layim-friend"+ah);ai["online"===ag?"removeClass":"addClass"]("layim-list-gray")},ab.prototype.content=function(ag){return layui.data.content(ag)};var M=function(ah){var ag={friend:"该分组下暂无好友",group:"暂无群组",history:"暂无历史会话"};return ah=ah||{},ah.item=ah.item||"d."+ah.type,["{{# var length = 0; layui.each("+ah.item+", function(i, data){ length++; }}",'<li layim-event="chat" data-type="'+ah.type+'" data-index="{{ '+(ah.index||"i")+' }}" class="layim-'+("history"===ah.type?"{{i}}":ah.type+"{{data.id}}")+' {{ data.status === "offline" ? "layim-list-gray" : "" }}"><img src="{{ data.avatar }}"><span>{{ data.username||data.groupname||data.name||"佚名" }}</span><p>{{ data.remark||data.sign||"" }}</p><span class="layim-msg-status">new</span></li>',"{{# }); if(length === 0){ }}",'<li class="layim-null">'+(ag[ah.type]||"暂无数据")+"</li>","{{# } }}"].join("")},Q=['<div class="layui-layim-main">','<div class="layui-layim-info">','<div class="layui-layim-user">{{ d.mine.username }}</div>','<div class="layui-layim-status">','{{# if(d.mine.status === "online"){ }}','<span class="layui-icon layim-status-online" layim-event="status" lay-type="show">&#xe617;</span>','{{# } else if(d.mine.status === "hide") { }}','<span class="layui-icon layim-status-hide" layim-event="status" lay-type="show">&#xe60f;</span>',"{{# } }}",'<ul class="layui-anim layim-menu-box">','<li {{d.mine.status === "online" ? "class=layim-this" : ""}} layim-event="status" lay-type="online"><i class="layui-icon">&#xe618;</i><cite class="layui-icon layim-status-online">&#xe617;</cite>在线</li>','<li {{d.mine.status === "hide" ? "class=layim-this" : ""}} layim-event="status" lay-type="hide"><i class="layui-icon">&#xe618;</i><cite class="layui-icon layim-status-hide">&#xe60f;</cite>隐身</li>',"</ul>","</div>",'<input class="layui-layim-remark" placeholder="编辑签名" value="{{ d.mine.remark||d.mine.sign||"" }}">',"</div>",'<ul class="layui-unselect layui-layim-tab{{# if(!d.base.isfriend || !d.base.isgroup){ }}'," layim-tab-two",'{{# } }}">','<li class="layui-icon',"{{# if(!d.base.isfriend){ }}"," layim-hide","{{# } else { }}"," layim-this","{{# } }}",'" title="联系人" layim-event="tab" lay-type="friend">&#xe612;</li>','<li class="layui-icon',"{{# if(!d.base.isgroup){ }}"," layim-hide","{{# } else if(!d.base.isfriend) { }}"," layim-this","{{# } }}",'" title="群组" layim-event="tab" lay-type="group">&#xe613;</li>','<li class="layui-icon" title="历史会话" layim-event="tab" lay-type="history">&#xe611;</li>',"</ul>",'<ul class="layui-unselect layim-tab-content {{# if(d.base.isfriend){ }}layui-show{{# } }} layim-list-friend">','{{# layui.each(d.friend, function(index, item){ var spread = d.local["spread"+index]; }}',"<li>",'<h5 layim-event="spread" lay-type="{{ spread }}"><i class="layui-icon">{{# if(spread === "true"){ }}&#xe61a;{{# } else {  }}&#xe602;{{# } }}</i><span>{{ item.groupname||"未命名分组"+index }}</span><em>(<cite class="layim-count"> {{ (item.list||[]).length }}</cite>)</em></h5>','<ul class="layui-layim-list {{# if(spread === "true"){ }}'," layui-show",'{{# } }}">',M({type:"friend",item:"item.list",index:"index"}),"</ul>","</li>","{{# }); if(d.friend.length === 0){ }}",'<li><ul class="layui-layim-list layui-show"><li class="layim-null">暂无联系人</li></ul>',"{{# } }}","</ul>",'<ul class="layui-unselect layim-tab-content {{# if(!d.base.isfriend && d.base.isgroup){ }}layui-show{{# } }}">',"<li>",'<ul class="layui-layim-list layui-show layim-list-group">',M({type:"group"}),"</ul>","</li>","</ul>",'<ul class="layui-unselect layim-tab-content  {{# if(!d.base.isfriend && !d.base.isgroup){ }}layui-show{{# } }}">',"<li>",'<ul class="layui-layim-list layui-show layim-list-history">',M({type:"history"}),"</ul>","</li>","</ul>",'<ul class="layui-unselect layim-tab-content">',"<li>",'<ul class="layui-layim-list layui-show" id="layui-layim-search"></ul>',"</li>","</ul>",'<ul class="layui-unselect layui-layim-tool">','<li class="layui-icon layim-tool-search" layim-event="search" title="搜索">&#xe615;</li>',"{{# if(d.base.msgbox){ }}",'<li class="layui-icon layim-tool-msgbox" layim-event="msgbox" title="消息盒子">&#xe645;<span class="layui-anim"></span></li>',"{{# } }}","{{# if(d.base.find){ }}",'<li class="layui-icon layim-tool-find" layim-event="find" title="查找">&#xe608;</li>',"{{# } }}",'<li class="layui-icon layim-tool-skin" layim-event="skin" title="更换背景">&#xe61b;</li>',"{{# if(!d.base.copyright){ }}",'<li class="layui-icon layim-tool-about" layim-event="about" title="关于">&#xe60b;</li>',"{{# } }}","</ul>",'<div class="layui-layim-search"><input><label class="layui-icon" layim-event="closeSearch">&#x1007;</label></div>',"</div>"].join(""),E=['<ul class="layui-layim-skin">',"{{# layui.each(d.skin, function(index, item){ }}",'<li><img layim-event="setSkin" src="{{ item }}"></li>',"{{# }); }}",'<li layim-event="setSkin"><cite>简约</cite></li>',"</ul>"].join(""),af=['<div class="layim-chat layim-chat-{{d.data.type}}{{d.first ? " layui-show" : ""}}">','<div class="layui-unselect layim-chat-title">','<div class="layim-chat-other">','<img class="layim-{{ d.data.type }}{{ d.data.id }}" src="{{ d.data.avatar }}"><span class="layim-chat-username" layim-event="{{ d.data.type==="group" ? "groupMembers" : "" }}">{{ d.data.name||"佚名" }} {{d.data.temporary ? "<cite>临时会话</cite>" : ""}} {{# if(d.data.type==="group"){ }} <em class="layim-chat-members"></em><i class="layui-icon">&#xe61a;</i> {{# } }}</span>','<p class="layim-chat-status"></p>',"</div>","</div>",'<div class="layim-chat-main">',"<ul></ul>","</div>",'<div class="layim-chat-footer">','<div class="layui-unselect layim-chat-tool" data-json="{{encodeURIComponent(JSON.stringify(d.data))}}">','<span class="layui-icon layim-tool-face" title="选择表情" layim-event="face">&#xe60c;</span>',"{{# if(d.base && d.base.uploadImage){ }}",'<span class="layui-icon layim-tool-image" title="上传图片" layim-event="image">&#xe60d;<input type="file" name="file"></span>',"{{# }; }}","{{# if(d.base && d.base.uploadFile){ }}",'<span class="layui-icon layim-tool-image" title="发送文件" layim-event="image" data-type="file">&#xe61d;<input type="file" name="file"></span>',"{{# }; }}","{{# if(d.base && d.base.isAudio){ }}",'<span class="layui-icon layim-tool-audio" title="发送网络音频" layim-event="media" data-type="audio">&#xe6fc;</span>',"{{# }; }}","{{# if(d.base && d.base.isVideo){ }}",'<span class="layui-icon layim-tool-video" title="发送网络视频" layim-event="media" data-type="video">&#xe6ed;</span>',"{{# }; }}","{{# layui.each(d.base.tool, function(index, item){ }}",'<span class="layui-icon layim-tool-{{item.alias}}" title="{{item.title}}" layim-event="extend" lay-filter="{{ item.alias }}">{{item.icon}}</span>',"{{# }); }}","{{# if(d.base && d.base.chatLog){ }}",'<span class="layim-tool-log" layim-event="chatLog"><i class="layui-icon">&#xe60e;</i>聊天记录</span>',"{{# }; }}","</div>",'<div class="layim-chat-textarea"><textarea></textarea></div>','<div class="layim-chat-bottom">','<div class="layim-chat-send">',"{{# if(!d.base.brief){ }}",'<span class="layim-send-close" layim-event="closeThisChat">关闭</span>',"{{# } }}",'<span class="layim-send-btn" layim-event="send">发送</span>','<span class="layim-send-set" layim-event="setSend" lay-type="show"><em class="layui-edge"></em></span>','<ul class="layui-anim layim-menu-box">','<li {{d.local.sendHotKey !== "Ctrl+Enter" ? "class=layim-this" : ""}} layim-event="setSend" lay-type="Enter"><i class="layui-icon">&#xe618;</i>按Enter键发送消息</li>','<li {{d.local.sendHotKey === "Ctrl+Enter" ? "class=layim-this" : ""}} layim-event="setSend"  lay-type="Ctrl+Enter"><i class="layui-icon">&#xe618;</i>按Ctrl+Enter键发送消息</li>',"</ul>","</div>","</div>","</div>","</div>"].join(""),H=['<div class="layim-add-box">','<div class="layim-add-img"><img class="layui-circle" src="{{ d.data.avatar }}"><p>{{ d.data.name||"" }}</p></div>','<div class="layim-add-remark">','{{# if(d.data.type === "friend" && d.type === "setGroup"){ }}',"<p>选择分组</p>",'{{# } if(d.data.type === "friend"){ }}','<select class="layui-select" id="LAY_layimGroup">',"{{# layui.each(d.data.group, function(index, item){ }}",'<option value="{{ item.id }}">{{ item.groupname }}</option>',"{{# }); }}","</select>","{{# } }}",'{{# if(d.data.type === "group"){ }}',"<p>请输入验证信息</p>",'{{# } if(d.type !== "setGroup"){ }}','<textarea id="LAY_layimRemark" placeholder="验证信息" class="layui-textarea"></textarea>',"{{# } }}","</div>","</div>"].join(""),z=['<li {{ d.mine ? "class=layim-chat-mine" : "" }} {{# if(d.cid){ }}data-cid="{{d.cid}}"{{# } }}>','<div class="layim-chat-user"><img src="{{ d.avatar }}"><cite>',"{{# if(d.mine){ }}",'<i>{{ layui.data.date(d.timestamp) }}</i>{{ d.username||"佚名" }}',"{{# } else { }}",'{{ d.username||"佚名" }}<i>{{ layui.data.date(d.timestamp) }}</i>',"{{# } }}","</cite></div>",'<div class="layim-chat-text">{{ layui.data.content(d.content||"&nbsp") }}</div>',"</li>"].join(""),N='<li class="layim-{{ d.data.type }}{{ d.data.id }} layim-chatlist-{{ d.data.type }}{{ d.data.id }} layim-this" layim-event="tabChat"><img src="{{ d.data.avatar }}"><span>{{ d.data.name||"佚名" }}</span>{{# if(!d.base.brief){ }}<i class="layui-icon" layim-event="closeChat">&#x1007;</i>{{# } }}</li>',y=function(ag){return ag<10?"0"+(0|ag):ag};layui.data.date=function(ah){var ag=new Date(ah||new Date);return ag.getFullYear()+"-"+y(ag.getMonth()+1)+"-"+y(ag.getDate())+" "+y(ag.getHours())+":"+y(ag.getMinutes())+":"+y(ag.getSeconds())},layui.data.content=function(ah){var ag=function(ai){return new RegExp("\\n*\\["+(ai||"")+"(code|pre|div|span|p|table|thead|th|tbody|tr|td|ul|li|ol|li|dl|dt|dd|h2|h3|h4|h5)([\\s\\S]*?)\\]\\n*","g")};return ah=(ah||"").replace(/&(?!#?[a-zA-Z0-9]+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#39;").replace(/"/g,"&quot;").replace(/@(\S+)(\s+?|$)/g,'@<a href="javascript:;">$1</a>$2').replace(/face\[([^\s\[\]]+?)\]/g,function(ai){var aj=ai.replace(/^face/g,"");return'<img alt="'+aj+'" title="'+aj+'" src="'+u[aj]+'">'}).replace(/img\[([^\s]+?)\]/g,function(ai){return'<img class="layui-layim-photos" src="'+ai.replace(/(^img\[)|(\]$)/g,"")+'">'}).replace(/file\([\s\S]+?\)\[[\s\S]*?\]/g,function(aj){var ak=(aj.match(/file\(([\s\S]+?)\)\[/)||[])[1],ai=(aj.match(/\)\[([\s\S]*?)\]/)||[])[1];return ak?'<a class="layui-layim-file" href="'+ak+'" download target="_blank"><i class="layui-icon">&#xe61e;</i><cite>'+(ai||ak)+"</cite></a>":aj}).replace(/audio\[([^\s]+?)\]/g,function(ai){return'<div class="layui-unselect layui-layim-audio" layim-event="playAudio" data-src="'+ai.replace(/(^audio\[)|(\]$)/g,"")+'"><i class="layui-icon">&#xe652;</i><p>音频消息</p></div>'}).replace(/video\[([^\s]+?)\]/g,function(ai){return'<div class="layui-unselect layui-layim-video" layim-event="playVideo" data-src="'+ai.replace(/(^video\[)|(\]$)/g,"")+'"><i class="layui-icon">&#xe652;</i></div>'}).replace(/a\([\s\S]+?\)\[[\s\S]*?\]/g,function(aj){var ak=(aj.match(/a\(([\s\S]+?)\)\[/)||[])[1],ai=(aj.match(/\)\[([\s\S]*?)\]/)||[])[1];return ak?'<a href="'+ak+'" target="_blank">'+(ai||ak)+"</a>":aj}).replace(ag(),"<$1 $2>").replace(ag("/"),"</$1>").replace(/\n/g,"<br>")};var P,aa,O,C,W,p=function(ai,ag,ah){return ai=ai||{},ad.ajax({url:ai.url,type:ai.type||"get",data:ai.data,dataType:ai.dataType||"json",cache:!1,success:function(aj){0==aj.code?ag&&ag(aj.data||{}):L.msg(aj.msg||(ah||"Error")+": LAYIM_NOT_GET_DATA",{time:5000})},error:function(aj,ak){window.console&&console.log&&console.error("LAYIM_DATE_ERROR："+ak)}})},B={message:{},chat:[]},d=function(ah){var ag=ah.init||{};return mine=ag.mine||{},local=layui.data("layim")[mine.id]||{},obj={base:ah,local:local,mine:mine,history:local.history||{}},create=function(ak){var aj=ak.mine||{},al=layui.data("layim")[aj.id]||{},ai={base:ah,local:al,mine:aj,friend:ak.friend||[],group:ak.group||[],history:al.history||{}};B=ad.extend(B,ai),i(F(Q).render(ai)),(al.close||ah.min)&&q(),layui.each(J.ready,function(am,an){an&&an(ai)})},B=ad.extend(B,obj),ah.brief?layui.each(J.ready,function(ai,aj){aj&&aj(obj)}):void (ag.url?p(ag,create,"INIT"):create(ag))},i=function(ag){return L.open({type:1,area:["260px","520px"],skin:"layui-box layui-layim",title:"&#8203;",offset:"rb",id:"layui-layim",shade:!1,anim:2,resize:!1,content:ag,success:function(aj){P=aj,o(aj),B.base.right&&aj.css("margin-left","-"+B.base.right),aa&&L.close(aa.attr("times"));var ah=[],ai=aj.find(".layim-list-history");ai.find("li").each(function(){ah.push(ad(this).prop("outerHTML"))}),ah.length>0&&(ah.reverse(),ai.html(ah.join(""))),U(),x.sign()},cancel:function(ai){q();var ah=layui.data("layim")[B.mine.id]||{};return ah.close=!0,layui.data("layim",{key:B.mine.id,value:ah}),!1}})},U=function(){P.on("contextmenu",function(ah){return ah.cancelBubble=!0,ah.returnValue=!1,!1});var ag=function(){L.closeAll("tips")};P.find(".layim-list-history").on("contextmenu","li",function(aj){var ai=ad(this),ah='<ul data-id="'+ai[0].id+'" data-index="'+ai.data("index")+'"><li layim-event="menuHistory" data-type="one">移除该会话</li><li layim-event="menuHistory" data-type="all">清空全部会话列表</li></ul>';ai.hasClass("layim-null")||(L.tips(ah,this,{tips:1,time:0,anim:5,fixed:!0,skin:"layui-box layui-layim-contextmenu",success:function(ak){var al=function(am){S(am)};ak.off("mousedown",al).on("mousedown",al)}}),ad(document).off("mousedown",ag).on("mousedown",ag),ad(window).off("resize",ag).on("resize",ag))})},q=function(ag){return aa&&L.close(aa.attr("times")),P&&P.hide(),B.mine=B.mine||{},L.open({type:1,title:!1,id:"layui-layim-close",skin:"layui-box layui-layim-min layui-layim-close",shade:!1,closeBtn:!1,anim:2,offset:"rb",resize:!1,content:'<img src="'+(B.mine.avatar||layui.cache.dir+"css/pc/layim/skin/logo.jpg")+'"><span>'+(ag||B.base.title||"我的LayIM")+"</span>",move:"#layui-layim-close img",success:function(ai,ah){aa=ai,B.base.right&&ai.css("margin-left","-"+B.base.right),ai.on("click",function(){L.close(ah),P.show();var aj=layui.data("layim")[B.mine.id]||{};delete aj.close,layui.data("layim",{key:B.mine.id,value:aj})})}})},R=function(al){al=al||{};var an=ad("#layui-layim-chat"),ah={data:al,base:B.base,local:B.local};if(!al.id){return L.msg("非法用户")}if(an[0]){var ak=O.find(".layim-chat-list"),ai=ak.find(".layim-chatlist-"+al.type+al.id),aj=O.find(".layui-layer-max").hasClass("layui-layer-maxmin"),ag=an.children(".layim-chat-box");return"none"===O.css("display")&&O.show(),C&&L.close(C.attr("times")),1!==ak.find("li").length||ai[0]||(aj||O.css("width",800),ak.css({height:O.height()}).show(),ag.css("margin-left","200px")),ai[0]||(ak.append(F(N).render(ah)),ag.append(F(af).render(ah)),f(al),a()),l(ak.find(".layim-chatlist-"+al.type+al.id)),ai[0]||m(),T(al),n(),W}ah.first=!0;var am=W=L.open({type:1,area:"600px",skin:"layui-box layui-layim-chat",id:"layui-layim-chat",title:"&#8203;",shade:!1,maxmin:!0,offset:al.offset||"auto",anim:al.anim||0,closeBtn:!B.base.brief&&1,content:F('<ul class="layui-unselect layim-chat-list">'+N+'</ul><div class="layim-chat-box">'+af+"</div>").render(ah),success:function(ao){O=ao,ao.css({"min-width":"500px","min-height":"420px"}),f(al),"function"==typeof al.success&&al.success(ao),n(),o(ao),T(al),m(),I(),layui.each(J.chatChange,function(ap,aq){aq&&aq(Y())}),ao.on("dblclick",".layui-layim-photos",function(){var ap=this.src;L.close(R.photosIndex),L.photos({photos:{data:[{alt:"大图模式",src:ap}]},shade:0.01,closeBtn:2,anim:0,resize:!1,success:function(aq,ar){R.photosIndex=ar}})})},full:function(ao){L.style(am,{width:"100%",height:"100%"},!0),a()},resizing:a,restore:a,min:function(){return k(),!1},end:function(){L.closeAll("tips"),O=null}});return am},f=function(ag){ad(".layim-"+ag.type+ag.id).each(function(){ad(this).hasClass("layim-list-gray")&&layui.layim.setFriendStatus(ag.id,"offline")})},a=function(){var ai=O.find(".layim-chat-list"),ag=O.find(".layim-chat-main"),ah=O.height();ai.css({height:ah}),ag.css({height:ah-20-80-158})},k=function(ai){var ag=ai||Y().data,ah=layui.layim.cache().base;O&&!ai&&O.hide(),L.close(k.index),k.index=L.open({type:1,title:!1,skin:"layui-box layui-layim-min",shade:!1,closeBtn:!1,anim:ag.anim||2,offset:"b",move:"#layui-layim-min",resize:!1,area:["182px","50px"],content:'<img id="layui-layim-min" src="'+ag.avatar+'"><span>'+ag.name+"</span>",success:function(aj,ak){ai||(C=aj),ah.minRight&&L.style(ak,{left:ad(window).width()-aj.outerWidth()-parseFloat(ah.minRight)}),aj.find(".layui-layer-content span").on("click",function(){L.close(ak),ai?layui.each(B.chat,function(al,am){R(am)}):O.show(),ai&&(B.chat=[],w())}),aj.find(".layui-layer-content img").on("click",function(al){S(al)})}})},j=function(ah,ag){return ah=ah||{},L.close(j.index),j.index=L.open({type:1,area:"430px",title:{friend:"添加好友",group:"加入群组"}[ah.type]||"",shade:!1,resize:!1,btn:ag?["确认","取消"]:["发送申请","关闭"],content:F(H).render({data:{name:ah.username||ah.groupname,avatar:ah.avatar,group:ah.group||parent.layui.layim.cache().friend||[],type:ah.type},type:ag}),yes:function(ak,al){var aj=al.find("#LAY_layimGroup"),ai=al.find("#LAY_layimRemark");ag?ah.submit&&ah.submit(aj.val(),ak):ah.submit&&ah.submit(aj.val(),ai.val(),ak)}})},l=function(ak,am){ak=ak||ad(".layim-chat-list ."+G);var ah=ak.index()===-1?0:ak.index(),ag=".layim-chat",aj=O.find(ag).eq(ah),ai=O.find(".layui-layer-max").hasClass("layui-layer-maxmin");if(am){ak.hasClass(G)&&l(0===ah?ak.next():ak.prev());var al=O.find(ag).length;return 1===al?L.close(W):(ak.remove(),aj.remove(),2===al&&(O.find(".layim-chat-list").hide(),ai||O.css("width","600px"),O.find(".layim-chat-box").css("margin-left",0)),!1)}ak.addClass(G).siblings().removeClass(G),aj.addClass(K).siblings(ag).removeClass(K),aj.find("textarea").focus(),layui.each(J.chatChange,function(an,ao){ao&&ao(Y())}),I()},I=function(){var ah=Y(),ag=B.message[ah.data.type+ah.data.id];ag&&delete B.message[ah.data.type+ah.data.id]},Y=function(){if(O){var ah=ad(".layim-chat-list ."+G).index(),ag=O.find(".layim-chat").eq(ah),ai=JSON.parse(decodeURIComponent(ag.find(".layim-chat-tool").data("json")));return{elem:ag,data:ai,textarea:ag.find("textarea")}}},o=function(ai){var ag=layui.data("layim")[B.mine.id]||{},ah=ag.skin;ai.css({"background-image":ah?"url("+ah+")":function(){return B.base.initSkin?"url("+(layui.cache.dir+"css/modules/layim/skin/"+B.base.initSkin)+")":"none"}()})},T=function(ak){var am=layui.data("layim")[B.mine.id]||{},ai={},al=am.history||{},ag=al[ak.type+ak.id];if(P){var aj=P.find(".layim-list-history");if(ak.historyTime=(new Date).getTime(),al[ak.type+ak.id]=ak,am.history=al,layui.data("layim",{key:B.mine.id,value:am}),!ag){ai[ak.type+ak.id]=ak;var ah=F(M({type:"history",item:"d.data"})).render({data:ai});aj.prepend(ah),aj.find(".layim-null").remove()}}},X=function(){var ak={username:B.mine?B.mine.username:"访客",avatar:B.mine?B.mine.avatar:layui.cache.dir+"css/pc/layim/skin/logo.jpg",id:B.mine?B.mine.id:null,mine:!0},al=Y(),ai=al.elem.find(".layim-chat-main ul"),ag=B.base.maxLength||3000;if(ak.content=al.textarea.val(),""!==ak.content.replace(/\s/g,"")){if(ak.content.length>ag){return L.msg("内容最长不能超过"+ag+"个字符")}ai.append(F(z).render(ak));var aj={mine:ak,to:al.data},ah={username:aj.mine.username,avatar:aj.mine.avatar,id:aj.to.id,type:aj.to.type,content:aj.mine.content,timestamp:(new Date).getTime(),mine:!0};V(ah),layui.each(J.sendMessage,function(am,an){an&&an(aj)})}w(),al.textarea.val("").focus()},g=function(ag){if(ag=ag||{},window.Notification){if("granted"===Notification.permission){new Notification(ag.title||"",{body:ag.content||"",icon:ag.avatar||"http://tp2.sinaimg.cn/5488749285/50/5719808192/1"})}else{Notification.requestPermission()}}},b=function(){if(!(D.ie&&D.ie<9)){var ag=document.createElement("audio");ag.src=layui.cache.dir+"css/modules/layim/voice/"+B.base.voice,ag.play()}},c={},h=function(al){al=al||{};var ai=ad(".layim-chatlist-"+al.type+al.id),ah={},am=ai.index();if(al.timestamp=al.timestamp||(new Date).getTime(),al.fromid==B.mine.id&&(al.mine=!0),al.system||V(al),c=JSON.parse(JSON.stringify(al)),B.base.voice&&b(),!O&&al.content||am===-1){if(B.message[al.type+al.id]){B.message[al.type+al.id].push(al)}else{if(B.message[al.type+al.id]=[al],"friend"===al.type){var ag;layui.each(B.friend,function(aq,ap){if(layui.each(ap.list,function(at,ar){if(ar.id==al.id){return ar.type="friend",ar.name=ar.username,B.chat.push(ar),ag=!0}}),ag){return !0}}),ag||(al.name=al.username,al.temporary=!0,B.chat.push(al))}else{if("group"===al.type){var an;layui.each(B.group,function(aq,ap){if(ap.id==al.id){return ap.type="group",ap.name=ap.groupname,B.chat.push(ap),an=!0}}),an||(al.name=al.groupname,B.chat.push(al))}else{al.name=al.name||al.username||al.groupname,B.chat.push(al)}}}if("group"===al.type&&layui.each(B.group,function(aq,ap){if(ap.id==al.id){return ah.avatar=ap.avatar,!0}}),!al.system){return B.base.notice&&g({title:"来自 "+al.username+" 的消息",content:al.content,avatar:ah.avatar||al.avatar}),k({name:"收到新消息",avatar:ah.avatar||al.avatar,anim:6})}}if(O){var ak=Y();ak.data.type+ak.data.id!==al.type+al.id&&(ai.addClass("layui-anim layer-anim-06"),setTimeout(function(){ai.removeClass("layui-anim layer-anim-06")},300));var ao=O.find(".layim-chat").eq(am),aj=ao.find(".layim-chat-main ul");al.system?am!==-1&&aj.append('<li class="layim-chat-system"><span>'+al.content+"</span></li>"):""!==al.content.replace(/\s/g,"")&&aj.append(F(z).render(al)),w()}},v="layui-anim-loop layer-anim-05",s=function(ah){var ag=P.find(".layim-tool-msgbox");ag.find("span").addClass(v).html(ah)},V=function(ai){var ag=layui.data("layim")[B.mine.id]||{};ag.chatlog=ag.chatlog||{};var ah=ag.chatlog[ai.type+ai.id];if(ah){var aj;layui.each(ah,function(al,ak){ak.timestamp===ai.timestamp&&ak.type===ai.type&&ak.id===ai.id&&ak.content===ai.content&&(aj=!0)}),aj||ai.fromid==B.mine.id||ah.push(ai),ah.length>ac&&ah.shift()}else{ag.chatlog[ai.type+ai.id]=[ai]}layui.data("layim",{key:B.mine.id,value:ag})},m=function(){var ai=layui.data("layim")[B.mine.id]||{},ag=Y(),ah=ai.chatlog||{},aj=ag.elem.find(".layim-chat-main ul");layui.each(ah[ag.data.type+ag.data.id],function(ak,al){aj.append(F(z).render(al))}),w()},r=function(ak){var al,ai={},ag=P.find(".layim-list-"+ak.type);if(B[ak.type]){if("friend"===ak.type){layui.each(B.friend,function(an,am){if(ak.groupid==am.id){return layui.each(B.friend[an].list,function(ao,ap){if(ap.id==ak.id){return al=!0}}),al?L.msg("好友 ["+(ak.username||"")+"] 已经存在列表中",{anim:6}):(B.friend[an].list=B.friend[an].list||[],ai[B.friend[an].list.length]=ak,ak.groupIndex=an,B.friend[an].list.push(ak),!0)}})}else{if("group"===ak.type){if(layui.each(B.group,function(an,am){if(am.id==ak.id){return al=!0}}),al){return L.msg("您已是 ["+(ak.groupname||"")+"] 的群成员",{anim:6})}ai[B.group.length]=ak,B.group.push(ak)}}}if(!al){var aj=F(M({type:ak.type,item:"d.data",index:"friend"===ak.type?"data.groupIndex":null})).render({data:ai});if("friend"===ak.type){var ah=ag.find(">li").eq(ak.groupIndex);ah.find(".layui-layim-list").append(aj),ah.find(".layim-count").html(B.friend[ak.groupIndex].list.length),ah.find(".layim-null")[0]&&ah.find(".layim-null").remove()}else{"group"===ak.type&&(ag.append(aj),ag.find(".layim-null")[0]&&ag.find(".layim-null").remove())}}},t=function(ah){var ag=P.find(".layim-list-"+ah.type);B[ah.type]&&("friend"===ah.type?layui.each(B.friend,function(aj,ai){layui.each(ai.list,function(al,ak){if(ah.id==ak.id){var am=ag.find(">li").eq(aj);am.find(".layui-layim-list>li");return am.find(".layui-layim-list>li").eq(al).remove(),B.friend[aj].list.splice(al,1),am.find(".layim-count").html(B.friend[aj].list.length),0===B.friend[aj].list.length&&am.find(".layui-layim-list").html('<li class="layim-null">该分组下已无好友了</li>'),!0}})}):"group"===ah.type&&layui.each(B.group,function(aj,ai){if(ah.id==ai.id){return ag.find(">li").eq(aj).remove(),B.group.splice(aj,1),0===B.group.length&&ag.html('<li class="layim-null">暂无群组</li>'),!0}}))},w=function(){var aj=Y(),ag=aj.elem.find(".layim-chat-main"),ai=ag.find("ul"),ak=ai.find("li").length;if(ak>=ac){var ah=ai.find("li").eq(0);ai.prev().hasClass("layim-chat-system")||ai.before('<div class="layim-chat-system"><span layim-event="chatLog">查看更多记录</span></div>'),ak>ac&&ah.remove()}ag.scrollTop(ag[0].scrollHeight+1000),ag.find("ul li:last").find("img").load(function(){ag.scrollTop(ag[0].scrollHeight+1000)})},n=function(){var ah=Y(),ag=ah.textarea;ag.focus(),ag.off("keydown").on("keydown",function(ak){var aj=layui.data("layim")[B.mine.id]||{},ai=ak.keyCode;if("Ctrl+Enter"===aj.sendHotKey){return void (ak.ctrlKey&&13===ai&&X())}if(13===ai){if(ak.ctrlKey){return ag.val(ag.val()+"\n")}if(ak.shiftKey){return}ak.preventDefault(),X()}})},u=function(){var ah=["[微笑]","[嘻嘻]","[哈哈]","[可爱]","[可怜]","[挖鼻]","[吃惊]","[害羞]","[挤眼]","[闭嘴]","[鄙视]","[爱你]","[泪]","[偷笑]","[亲亲]","[生病]","[太开心]","[白眼]","[右哼哼]","[左哼哼]","[嘘]","[衰]","[委屈]","[吐]","[哈欠]","[抱抱]","[怒]","[疑问]","[馋嘴]","[拜拜]","[思考]","[汗]","[困]","[睡]","[钱]","[失望]","[酷]","[色]","[哼]","[鼓掌]","[晕]","[悲伤]","[抓狂]","[黑线]","[阴险]","[怒骂]","[互粉]","[心]","[伤心]","[猪头]","[熊猫]","[兔子]","[ok]","[耶]","[good]","[NO]","[赞]","[来]","[弱]","[草泥马]","[神马]","[囧]","[浮云]","[给力]","[围观]","[威武]","[奥特曼]","[礼物]","[钟]","[话筒]","[蜡烛]","[蛋糕]"],ag={};return layui.each(ah,function(ai,aj){ag[aj]=layui.cache.dir+"images/face/"+ai+".gif"}),ag}(),S=layui.stope,e=function(ai,ag){var ah,aj=ai.value;ai.focus(),document.selection?(ah=document.selection.createRange(),document.selection.empty(),ah.text=ag):(ah=[aj.substring(0,ai.selectionStart),ag,aj.substr(ai.selectionEnd)],ai.focus(),ai.value=ah.join(""))},ae="layui-anim-upbit",x={status:function(ai,ak){var aj=function(){ai.next().hide().removeClass(ae)},ah=ai.attr("lay-type");if("show"===ah){S(ak),ai.next().show().addClass(ae),ad(document).off("click",aj).on("click",aj)}else{var ag=ai.parent().prev();ai.addClass(G).siblings().removeClass(G),ag.html(ai.find("cite").html()),ag.removeClass("layim-status-"+("online"===ah?"hide":"online")).addClass("layim-status-"+ah),layui.each(J.online,function(al,am){am&&am(ah)})}},sign:function(){var ag=P.find(".layui-layim-remark");ag.on("change",function(){var ah=this.value;layui.each(J.sign,function(aj,ai){ai&&ai(ah)})}),ag.on("keyup",function(ai){var ah=ai.keyCode;13===ah&&this.blur()})},tab:function(ai){var ag,ah=".layim-tab-content",aj=P.find(".layui-layim-tab>li");"number"==typeof ai?(ag=ai,ai=aj.eq(ag)):ag=ai.index(),ag>2?aj.removeClass(G):(x.tab.index=ag,ai.addClass(G).siblings().removeClass(G)),P.find(ah).eq(ag).addClass(K).siblings(ah).removeClass(K)},spread:function(ai){var ag=ai.attr("lay-type"),ah="true"===ag?"false":"true",aj=layui.data("layim")[B.mine.id]||{};ai.next()["true"===ag?"removeClass":"addClass"](K),aj["spread"+ai.parent().index()]=ah,layui.data("layim",{key:B.mine.id,value:aj}),ai.attr("lay-type",ah),ai.find(".layui-icon").html("true"===ah?"&#xe61a;":"&#xe602;")},search:function(aj){var ag=P.find(".layui-layim-search"),ai=P.find("#layui-layim-search"),ak=ag.find("input"),ah=function(an){var av=ak.val().replace(/\s/);if(""===av){x.tab(0|x.tab.index)}else{for(var ap=[],ao=B.friend||[],at=B.group||[],aq="",am=0;am<ao.length;am++){for(var ar=0;ar<(ao[am].list||[]).length;ar++){ao[am].list[ar].username.indexOf(av)!==-1&&(ao[am].list[ar].type="friend",ao[am].list[ar].index=am,ao[am].list[ar].list=ar,ap.push(ao[am].list[ar]))}}for(var al=0;al<at.length;al++){at[al].groupname.indexOf(av)!==-1&&(at[al].type="group",at[al].index=al,at[al].list=al,ap.push(at[al]))}if(ap.length>0){for(var au=0;au<ap.length;au++){aq+='<li layim-event="chat" data-type="'+ap[au].type+'" data-index="'+ap[au].index+'" data-list="'+ap[au].list+'"><img src="'+ap[au].avatar+'"><span>'+(ap[au].username||ap[au].groupname||"佚名")+"</span><p>"+(ap[au].remark||ap[au].sign||"")+"</p></li>"}}else{aq='<li class="layim-null">无搜索结果</li>'}ai.html(aq),x.tab(3)}};!B.base.isfriend&&B.base.isgroup?x.tab.index=1:B.base.isfriend||B.base.isgroup||(x.tab.index=2),ag.show(),ak.focus(),ak.off("keyup",ah).on("keyup",ah)},closeSearch:function(ag){ag.parent().hide(),x.tab(0|x.tab.index)},msgbox:function(){var ag=P.find(".layim-tool-msgbox");return L.close(x.msgbox.index),ag.find("span").removeClass(v).html(""),x.msgbox.index=L.open({type:2,title:"消息盒子",shade:!1,maxmin:!0,area:["600px","520px"],skin:"layui-box layui-layer-border",resize:!1,content:B.base.msgbox})},find:function(){return L.close(x.find.index),x.find.index=L.open({type:2,title:"查找",shade:!1,maxmin:!0,area:["1000px","520px"],skin:"layui-box layui-layer-border",resize:!1,content:B.base.find})},skin:function(){L.open({type:1,title:"更换背景",shade:!1,area:"300px",skin:"layui-box layui-layer-border",id:"layui-layim-skin",zIndex:66666666,resize:!1,content:F(E).render({skin:B.base.skin})})},about:function(){L.alert("版本： "+Z+'<br>版权所有：<a href="http://layim.layui.com" target="_blank">layim.layui.com</a>',{title:"关于 LayIM",shade:!1})},setSkin:function(ai){var ag=ai.attr("src"),ah=layui.data("layim")[B.mine.id]||{};ah.skin=ag,ag||delete ah.skin,layui.data("layim",{key:B.mine.id,value:ah});try{P.css({"background-image":ag?"url("+ag+")":"none"}),O.css({"background-image":ag?"url("+ag+")":"none"})}catch(aj){}layui.each(J.setSkin,function(am,al){var ak=(ag||"").replace(layui.cache.dir+"css/modules/layim/skin/","");al&&al(ak,ag)})},chat:function(aj){var al=layui.data("layim")[B.mine.id]||{},ai=aj.data("type"),ak=aj.data("index"),ah=aj.attr("data-list")||aj.index(),ag={};"friend"===ai?ag=B[ai][ak].list[ah]:"group"===ai?ag=B[ai][ah]:"history"===ai&&(ag=(al.history||{})[ak]||{}),ag.name=ag.name||ag.username||ag.groupname,"history"!==ai&&(ag.type=ai),R(ag)},tabChat:function(ag){l(ag)},closeChat:function(ah,ag){l(ah.parent(),1),S(ag)},closeThisChat:function(){l(null,1)},groupMembers:function(aj,ak){var ah=aj.find(".layui-icon"),ag=function(){ah.html("&#xe61a;"),aj.data("down",null),L.close(x.groupMembers.index)},ai=function(al){S(al)};aj.data("down")?ag():(ah.html("&#xe619;"),aj.data("down",!0),x.groupMembers.index=L.tips('<ul class="layim-members-list"></ul>',aj,{tips:3,time:0,anim:5,fixed:!0,skin:"layui-box layui-layim-members",success:function(ar){var ap=B.base.members||{},at=Y(),ao=ar.find(".layim-members-list"),am="",an={},al=O.find(".layui-layer-max").hasClass("layui-layer-maxmin"),aq="none"===O.find(".layim-chat-list").css("display");al&&ao.css({width:ad(window).width()-22-(aq||200)}),ap.data=ad.extend(ap.data,{id:at.data.id}),p(ap,function(au){layui.each(au.list,function(av,aw){am+='<li data-uid="'+aw.id+'"><a href="javascript:;"><img src="'+aw.avatar+'"><cite>'+aw.username+"</cite></a></li>",an[aw.id]=aw}),ao.html(am),aj.find(".layim-chat-members").html(au.members||(au.list||[]).length+"人"),ao.find("li").on("click",function(){var av=ad(this).data("uid"),aw=an[av];R({name:aw.username,type:"friend",avatar:aw.avatar,id:aw.id}),ag()}),layui.each(J.members,function(av,aw){aw&&aw(au)})}),ar.on("mousedown",function(au){S(au)})}}),ad(document).off("mousedown",ag).on("mousedown",ag),ad(window).off("resize",ag).on("resize",ag),aj.off("mousedown",ai).on("mousedown",ai))},send:function(){X()},setSend:function(ai,ak){var aj=x.setSend.box=ai.siblings(".layim-menu-box"),ah=ai.attr("lay-type");if("show"===ah){S(ak),aj.show().addClass(ae),ad(document).off("click",x.setSendHide).on("click",x.setSendHide)}else{ai.addClass(G).siblings().removeClass(G);var ag=layui.data("layim")[B.mine.id]||{};ag.sendHotKey=ah,layui.data("layim",{key:B.mine.id,value:ag}),x.setSendHide(ak,ai.parent())}},setSendHide:function(ah,ag){(ag||x.setSend.box).hide().removeClass(ae)},face:function(aj,ak){var ah="",ag=Y();for(var ai in u){ah+='<li title="'+ai+'"><img src="'+u[ai]+'"></li>'}ah='<ul class="layui-clear layim-face-list">'+ah+"</ul>",x.face.index=L.tips(ah,aj,{tips:1,time:0,fixed:!0,skin:"layui-box layui-layim-face",success:function(al){al.find(".layim-face-list>li").on("mousedown",function(am){S(am)}).on("click",function(){e(ag.textarea[0],"face"+this.title+" "),L.close(x.face.index)})}}),ad(document).off("mousedown",x.faceHide).on("mousedown",x.faceHide),ad(window).off("resize",x.faceHide).on("resize",x.faceHide),S(ak)},faceHide:function(){L.close(x.face.index)},image:function(aj){var ak=aj.data("type")||"images",ai={images:"uploadImage",file:"uploadFile"},ah=Y(),ag=B.base[ai[ak]]||{};layui.upload.render({url:ag.url||"",method:ag.type,elem:aj.find("input")[0],type:ak,done:function(al){0==al.code?(al.data=al.data||{},"images"===ak?e(ah.textarea[0],"img["+(al.data.src||"")+"]"):"file"===ak&&e(ah.textarea[0],"file("+(al.data.src||"")+")["+(al.data.name||"下载文件")+"]"),X()):L.msg(al.msg||"上传失败")}})},media:function(ai){var aj=ai.data("type"),ah={audio:"音频",video:"视频"},ag=Y();L.prompt({title:"请输入网络"+ah[aj]+"地址",shade:!1,offset:[ai.offset().top-ad(window).scrollTop()-158+"px",ai.offset().left+"px"]},function(ak,al){e(ag.textarea[0],aj+"["+ak+"]"),X(),L.close(al)})},extend:function(ai){var ag=ai.attr("lay-filter"),ah=Y();layui.each(J["tool("+ag+")"],function(ak,aj){aj&&aj.call(ai,function(al){e(ah.textarea[0],al)},X,ah)})},playAudio:function(aj){var ag=aj.data("audio"),ai=ag||document.createElement("audio"),ah=function(){ai.pause(),aj.removeAttr("status"),aj.find("i").html("&#xe652;")};return aj.data("error")?L.msg("播放音频源异常"):ai.play?void (aj.attr("status")?ah():(ag||(ai.src=aj.data("src")),ai.play(),aj.attr("status","pause"),aj.data("audio",ai),aj.find("i").html("&#xe651;"),ai.onended=function(){ah()},ai.onerror=function(){L.msg("播放音频源异常"),aj.data("error",!0),ah()})):L.msg("您的浏览器不支持audio")},playVideo:function(ai){var ag=ai.data("src"),ah=document.createElement("video");return ah.play?(L.close(x.playVideo.index),void (x.playVideo.index=L.open({type:1,title:"播放视频",area:["460px","300px"],maxmin:!0,shade:!1,content:'<div style="background-color: #000; height: 100%;"><video style="position: absolute; width: 100%; height: 100%;" src="'+ag+'" loop="loop" autoplay="autoplay"></video></div>'}))):L.msg("您的浏览器不支持video")},chatLog:function(ah){var ag=Y();return B.base.chatLog?(L.close(x.chatLog.index),x.chatLog.index=L.open({type:2,maxmin:!0,title:"与 "+ag.data.name+" 的聊天记录",area:["450px","100%"],shade:!1,offset:"rb",skin:"layui-box",anim:2,id:"layui-layim-chatlog",content:B.base.chatLog+"?id="+ag.data.id+"&type="+ag.data.type})):L.msg("未开启更多聊天记录")},menuHistory:function(am,an){var ah=layui.data("layim")[B.mine.id]||{},ag=am.parent(),al=am.data("type"),ai=P.find(".layim-list-history"),aj='<li class="layim-null">暂无历史会话</li>';if("one"===al){var ak=ah.history;delete ak[ag.data("index")],ah.history=ak,layui.data("layim",{key:B.mine.id,value:ah}),ad("#"+ag.data("id")).remove(),0===ai.find("li").length&&ai.html(aj)}else{"all"===al&&(delete ah.history,layui.data("layim",{key:B.mine.id,value:ah}),ai.html(aj))}L.closeAll("tips")}};A("layim",new ab)}).addcss("modules/layim/layim.css?v=3.60Pro","skinlayimcss");