new Vue({el:"#index",data:{balanShow:false,show:false,pIndex:"",goodsPay:[],adrArr:[],adrName:"",adrAdr:"",adrPhone:"",order_type:"送货上门",totals:0,sendPrice:0,sendPrice1:0,message:[],payFs:"zfb",motionId:[],motionZid:[],caridProid:[],specialId:"",shopId:"",numBuy:1,balance:"0.00",syBalnce:true},mounted:function(){var d=this;var c={carid_proid:"",is_car:"",type:"",shop_id:"",number:"",motion_id:"",motion_zpid:""};c.is_car=GetQueryStringAtob("is_car");c.carid_proid=GetQueryStringAtob("carid_proid");if(GetQueryStringAtob("is_car")==1){c.type=GetQueryStringAtob("type");c.shop_id=GetQueryStringAtob("shop_id");d.shopId=GetQueryStringAtob("shop_id");c.number=GetQueryStringAtob("number");d.numBuy=GetQueryStringAtob("number");c.motion_id=GetQueryStringAtob("motion_id");c.motion_zpid=GetQueryStringAtob("motion_zpid")}$.ajax({url:"/web_api/item/index.php?c=PC_shoppingcar&m=pay_list",async:false,data:c,dataType:"json",success:function(b){if(b.login_status==0){vm.loginModel()}else{if(b.status==1){if(b.data.ress_address.length!=0){d.adrArr=b.data.ress_address;d.adrName=b.data.ress_address[0].user_name;d.adrAdr=b.data.ress_address[0].province+b.data.ress_address[0].city+b.data.ress_address[0].area+b.data.ress_address[0].address;d.adrPhone=b.data.ress_address[0].mobile}d.goodsPay=b.data.goods;d.balance=b.data.b2b_balance;d.sendPrice=parseFloat(b.data.special_money);d.sendPrice1=parseFloat(b.data.special_money);d.totals=b.data.amount_pay-d.sendPrice;var a=b.data.goods;$.each(a,function(e){var k="";var i=[];var j="";d.specialId+=(a[e].special_id||0)+",";$.each(a[e].data_child,function(f){k+=(a[e].data_child[f].motion_id||0)+",";i.push(a[e].data_child[f].motion_zpid||0);j+=a[e].data_child[f].id+","});d.motionId.push(k);d.motionZid.push(i);d.caridProid.push(j)});vm.imgHover()}else{layer.msg(b.msg)}}}})},methods:{promoIndex:function(m,q,r,p,o){var u=m.currentTarget;var n=this;n.pIndex=$(u).val();var t=n.goodsPay[q].data_child[r].Promotion;$(u).parent().siblings().find(".promoTitle").html(t[n.pIndex].title);$(u).parent().siblings().find(".promoZP").hide();n.motionId=[];n.motionZid=[];$.each(n.goodsPay,function(c){var b="";var a=[];$.each(n.goodsPay[c].data_child,function(d){if(c==q&&d==r){$.each(n.goodsPay[c].data_child[d].Promotion,function(f){if(f==n.pIndex){b+=(n.goodsPay[c].data_child[d].Promotion[f].id||0)+",";$.each(n.goodsPay[c].data_child[d].Promotion[f].titles,function(g){a+=(n.goodsPay[c].data_child[d].Promotion[f].titles.id||0)+","})}})}else{b+=(n.goodsPay[c].data_child[d].motion_id||0)+",";a.push(n.goodsPay[c].data_child[d].motion_zpid||0)}});n.motionId.push(b);n.motionZid.push(a)});if(t[n.pIndex].type=="mzhe"){var v=Math.floor(p/t[n.pIndex].mzhe_number);if(v>0){v*t[n.pIndex].reduce_amount>t[n.pIndex].point?v=10-t[n.pIndex].point:v=v*t[n.pIndex].reduce_amount;var e=(p*o*(1-(v*0.1))).toFixed(2);$(u).parent().siblings().find(".total").html("￥"+e)}}else{if(t[n.pIndex].type=="mjy"){if(p*o>=t[n.pIndex].full_amount){var e=(p*o-t[n.pIndex].reduce_amount).toFixed(2);$(u).parent().siblings().find(".total").html("￥"+e)}}else{if(t[n.pIndex].type=="mjt"){if(p>=t[n.pIndex].mj_number){var e=(p*o-t[n.pIndex].reduce_amount).toFixed(2);$(u).parent().siblings().find(".total").html("￥"+e)}}else{if(t[n.pIndex].type=="mzeng"){var s="赠：";$.each(t[n.pIndex].titles,function(a){s+='<img class="toolimg" alt="'+t[n.pIndex].titles[a].zp_title+'" src="'+t[n.pIndex].titles[a].zp_pro_img+'"/>'});$(u).parent().siblings().find(".promoZP").show().html(s);var e=(p*o).toFixed(2);$(u).parent().siblings().find(".total").html("￥"+e);vm.imgHover()}}}}n.totalz();n.total()},totalz:function(){var b=this;b.sendPrice=0;b.sendPrice1=0;$("tbody").each(function(){var f=0;var a=$(this).index()-1;$(this).find(".total").each(function(){var c=parseFloat($(this).text().substring(1));f+=c});var e=b.goodsPay[a];if(e.full_money&&f>=e.full_money){b.sendPrice-=Math.floor(f)*e.reduce_percen*0.01;b.sendPrice1-=Math.floor(f)*e.reduce_percen*0.01}else{if(e.full_money&&f>=e.droop_moneys){b.sendPrice+=Math.floor(f)*e.collect_percen*0.01;b.sendPrice1+=Math.floor(f)*e.collect_percen*0.01}else{if(e.collect_money){b.sendPrice+=parseFloat(e.collect_money);b.sendPrice1+=parseFloat(e.collect_money)}}}})},total:function(){var b=this;b.totals=0;$(".total").each(function(){var a=parseFloat($(this).text().substring(1));b.totals+=a})},payClick:function(){var b=this;if(b.order_type=="送货上门"&&b.adrName==""){layer.msg("请添加收货地址！");return false}if(b.payFs=="Balance"){if(b.totals+b.sendPrice>b.balance){layer.msg("您的余额不足！请选择其他支付方式或者前往充值！");return false}else{layer.prompt({title:"请输入支付密码！",formType:1},function(i,j){var h=Date.parse(new Date());h=h/1000;var a="pay_pwd="+i+"&timestamp="+h+"&user_id="+vm.user.uId+"&key=H1ereN3nfdF6wZcoeBdYUfQv7tq1Pq5t";var g=md5(a).toUpperCase();$.ajax({url:"/web_api/item/index.php?c=PC_order&m=order_add",async:true,data:{dealer_name:b.adrName,dealer_mobile:b.adrPhone,dealer_address:b.adrAdr,message:b.message,order_type:b.order_type,pay_type:b.payFs,motion_id:b.motionId,motion_zpid:b.motionZid,pay_device:"PC",coupon_id:"",is_car:GetQueryStringAtob("is_car"),carid_proid:b.caridProid,special_id:b.specialId,shop_id:b.shopId,number:b.numBuy,pwd:g},dataType:"json",success:function(c){if(c.login_status==0){vm.loginModel()}else{if(c.status=="5"){layer.closeAll();layer.msg(c.msg,{time:2000,end:function(){location.replace("myself.html");sessionStorage.setItem("index",2)}})}else{layer.msg(c.msg)}}}})})}}else{$.ajax({url:"/web_api/item/index.php?c=PC_order&m=order_add",async:true,data:{dealer_name:b.adrName,dealer_mobile:b.adrPhone,dealer_address:b.adrAdr,message:b.message,order_type:b.order_type,pay_type:b.payFs,motion_id:b.motionId,motion_zpid:b.motionZid,pay_device:"PC",coupon_id:"",is_car:GetQueryStringAtob("is_car"),carid_proid:b.caridProid,special_id:b.specialId,shop_id:b.shopId,number:b.numBuy},dataType:"json",success:function(k){if(k.login_status==0){vm.loginModel()}else{if(k.status==2){location.replace("/web_api/alipay/pagepay/pagepay.php")}else{if(k.status==3){var l=k.data;var i=k.order_id;var j=k.order_seqno;var a=function(){$.ajax({url:"/web_api/item/index.php?c=PC_order&m=query_order",async:false,data:{order_seqno:j,order_id:i},dataType:"json",success:function(c){if(c.status==1){layer.msg(c.msg,{shade:0.3,time:1500,end:function(){location.replace("myself.html");sessionStorage.setItem("index",2)}})}}})};var h=setInterval(a,3000);layer.open({type:1,shade:0.3,area:["240px","270px"],title:false,content:'<div style="padding: 10px;"><div class="tc"><img style="width: 200px;" src="'+l+'" alt=""></div><div style="display: flex; justify-content: space-between; width: 140px; margin: 5px auto;"><div><img src="bulid/img/saoma.png" alt="" style="width: 32px;"></div><div style="color: rgb(148, 148, 148); text-align: left;"><div style="margin-top: -2px;">打开 <span style="color: rgb(255, 69, 2);">手机微信 &nbsp;&nbsp;&nbsp;</span></div><div style="margin-top: -4px;">扫一扫继续支付</div></div></div></div>',end:function(){location.replace("myself.html");sessionStorage.setItem("index",2)}})}else{if(k.status==4){location.replace("/web_api/unionpay/demo/api_01_gateway/Form_6_2_FrontConsume.php")}else{if(k.status==1){location.replace("myself.html");sessionStorage.setItem("index",2)}}}}}}})}},modelAdr:function(){$(".pick-area").html(" ");$(".pick-area6").pickArea({width:"340",borderColor:"#ff8c00",arrowColor:"#ff8c00",listBdColor:"#ff8c00",color:"#ff8c00",hoverColor:"#ff8c00",getVal:function(){}})},sureClick:function(h,j,g){var e=h.currentTarget;var i=this;if(!$(e).hasClass("active")){$(e).addClass("active").siblings().removeClass("active")}if(j=="adr"){i.adrName=$(e).children().eq(0).text().split("：")[1];i.adrAdr=$(e).children().eq(1).text().split("：")[1];i.adrPhone=$(e).children().eq(2).text().split("：")[1]}else{if(j=="deliver"){i.order_type=$(e).text();if($(e).index()==0){i.sendPrice=i.sendPrice1}else{i.sendPrice=0}}else{if(j=="pay"){i.payFs=g;if(g=="Balance"){i.balanShow=true;i.syBalnce=true}else{i.balanShow=false;i.syBalnce=false}}}}}}});